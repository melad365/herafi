---
phase: 02-user-profiles
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/app/provider/setup/page.tsx
  - src/components/forms/ProviderSetupForm.tsx
  - src/actions/provider.ts
  - middleware.ts
  - src/app/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can become a provider through a dedicated setup flow at /provider/setup"
    - "Provider setup collects skills, bio, years of experience, certifications, professional summary"
    - "After completing provider setup, user.isProvider is true and provider sections show on profile"
    - "Dashboard prompts user to set username if not yet set"
    - "Middleware protects /profile/edit and /provider/setup routes for authenticated users"
    - "Dashboard has navigation links to edit profile and view own profile"
  artifacts:
    - path: "src/app/provider/setup/page.tsx"
      provides: "Become a provider setup page"
    - path: "src/components/forms/ProviderSetupForm.tsx"
      provides: "Provider onboarding form component"
    - path: "src/actions/provider.ts"
      provides: "Server action for provider setup"
      exports: ["becomeProvider"]
    - path: "middleware.ts"
      provides: "Updated middleware with new protected routes"
    - path: "src/app/dashboard/page.tsx"
      provides: "Updated dashboard with profile links and username prompt"
  key_links:
    - from: "src/components/forms/ProviderSetupForm.tsx"
      to: "src/actions/provider.ts"
      via: "Server Action form submission"
      pattern: "becomeProvider"
    - from: "middleware.ts"
      to: "src/lib/auth.ts"
      via: "auth() session check"
      pattern: "isProtectedPage"
    - from: "src/app/dashboard/page.tsx"
      to: "/profile/edit"
      via: "Navigation link"
      pattern: "profile/edit"
---

<objective>
Build the "Become a Provider" flow, update the dashboard with profile navigation and username prompt, and extend middleware for new protected routes.

Purpose: This completes the user identity system by adding the intentional provider onboarding step, wiring the dashboard to profile features, and ensuring all new routes are properly protected. The provider flow is designed to feel deliberate — users actively choose to become providers.
Output: Working provider setup flow, updated dashboard with profile links, and comprehensive route protection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-profiles/02-CONTEXT.md
@.planning/phases/02-user-profiles/02-RESEARCH.md
@.planning/phases/02-user-profiles/02-01-SUMMARY.md
@.planning/phases/02-user-profiles/02-02-SUMMARY.md
@.planning/phases/02-user-profiles/02-03-SUMMARY.md
@middleware.ts
@src/app/dashboard/page.tsx
@src/lib/auth.ts
@src/lib/db.ts
@src/lib/validations/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider setup flow and server action</name>
  <files>src/actions/provider.ts, src/app/provider/setup/page.tsx, src/components/forms/ProviderSetupForm.tsx</files>
  <action>
**File: `src/actions/provider.ts`**

Server action for the "Become a Provider" flow:

```ts
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/db";
import { providerSchema } from "@/lib/validations/profile";
import { revalidatePath } from "next/cache";

export type ProviderActionState = {
  success: boolean;
  error?: string;
  fieldErrors?: Record<string, string[]>;
};

export async function becomeProvider(
  _prevState: ProviderActionState,
  formData: FormData
): Promise<ProviderActionState> {
  const session = await auth();
  if (!session?.user?.id) {
    return { success: false, error: "Not authenticated" };
  }

  // Parse skills and certifications from comma-separated or multi-input
  const skillsRaw = formData.get("skills") as string;
  const certsRaw = formData.get("certifications") as string;

  const raw = {
    providerBio: formData.get("providerBio") as string,
    professionalSummary: formData.get("professionalSummary") as string,
    skills: skillsRaw ? skillsRaw.split(",").map((s) => s.trim()).filter(Boolean) : [],
    yearsOfExperience: Number(formData.get("yearsOfExperience")),
    certifications: certsRaw ? certsRaw.split(",").map((s) => s.trim()).filter(Boolean) : [],
  };

  const parsed = providerSchema.safeParse(raw);
  if (!parsed.success) {
    return {
      success: false,
      fieldErrors: parsed.error.flatten().fieldErrors as Record<string, string[]>,
    };
  }

  try {
    // Phase 2 interim: isProvider flag controls provider section visibility.
    // Phase 3 will refine to gig-count-based visibility (sections show when user has created gigs).
    await prisma.user.update({
      where: { id: session.user.id },
      data: {
        isProvider: true,
        providerBio: parsed.data.providerBio,
        professionalSummary: parsed.data.professionalSummary,
        skills: parsed.data.skills,
        yearsOfExperience: parsed.data.yearsOfExperience,
        certifications: parsed.data.certifications,
      },
    });
  } catch (error) {
    return { success: false, error: "Failed to set up provider profile" };
  }

  revalidatePath("/dashboard");
  revalidatePath("/provider/setup");
  return { success: true };
}
```

**File: `src/components/forms/ProviderSetupForm.tsx`**

Client component for provider onboarding:
- Uses `react-hook-form` with `providerSchema` Zod resolver
- Submits via `useActionState` calling `becomeProvider` server action
- Fields:
  1. Professional Summary (textarea, "Brief summary of what you offer")
  2. Provider Bio (textarea, "Detailed description of your expertise and services")
  3. Skills (text input with instructions "Enter skills separated by commas", e.g., "Plumbing, Pipe Repair, Water Heater Installation")
  4. Years of Experience (number input)
  5. Certifications (text input, comma-separated, optional — "Enter certifications separated by commas")
- Single "Become a Provider" submit button (orange-600)
- On success, show success message and redirect to dashboard after 2 seconds
- Field-level error display below each input

Design: Make this feel intentional and exciting — maybe a brief intro section at top:
"Ready to offer your services? Complete your provider profile to start creating gigs and connecting with clients."

Styling: White card, rounded-lg, shadow-lg, warm orange/amber scheme.

**File: `src/app/provider/setup/page.tsx`**

Server component:
1. Check auth — redirect to `/login` if not authenticated
2. Check if user already has username — redirect to `/profile/edit` with message if not (must set up basic profile first)
3. Check if already a provider — redirect to `/dashboard` if `isProvider` is already true
4. Render the setup page with `ProviderSetupForm`

```tsx
import { auth } from "@/lib/auth";
import { redirect } from "next/navigation";
import { prisma } from "@/lib/db";
import ProviderSetupForm from "@/components/forms/ProviderSetupForm";

export default async function ProviderSetupPage() {
  const session = await auth();
  if (!session?.user?.id) redirect("/login");

  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: { username: true, isProvider: true },
  });

  if (!user) redirect("/login");
  if (!user.username) redirect("/profile/edit");
  if (user.isProvider) redirect("/dashboard");

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 via-amber-50 to-orange-100">
      <div className="max-w-2xl mx-auto px-6 py-12">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">Become a Provider</h1>
        <p className="text-gray-600 mb-8">Share your expertise and start offering services on Herafi.</p>
        <ProviderSetupForm />
      </div>
    </div>
  );
}
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no errors
2. Navigate to `/provider/setup` while logged in with username set — form renders
3. Fill in provider fields, submit — user.isProvider becomes true in database
4. Navigate to `/u/[username]` — provider sections now visible
5. Revisit `/provider/setup` — redirects to dashboard (already provider)
  </verify>
  <done>Provider setup flow works: form collects provider details, server action saves to database, user becomes a provider with visible provider sections on profile.</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard and middleware for profile routes</name>
  <files>src/app/dashboard/page.tsx, middleware.ts</files>
  <action>
**File: `middleware.ts`**

Update the existing middleware to protect new routes:

Add `/profile` and `/provider` to the protected pages check:
```ts
const isProtectedPage =
  nextUrl.pathname.startsWith("/dashboard") ||
  nextUrl.pathname.startsWith("/profile") ||
  nextUrl.pathname.startsWith("/provider");
```

Keep everything else the same (auth page redirects, matcher config). The `/u/[username]` route stays public (no auth required to view profiles).

**File: `src/app/dashboard/page.tsx`**

Update the existing dashboard page to:

1. Fetch user data including username and isProvider status from Prisma
2. Show a prominent username setup prompt if `user.username` is null:
   - Yellow/amber alert card: "Complete your profile! Set up your username and profile info to get started."
   - Link button to `/profile/edit`
3. Add navigation cards/links:
   - "Edit Profile" → `/profile/edit`
   - "View My Profile" → `/u/[username]` (only if username is set)
   - "Become a Provider" → `/provider/setup` (only if NOT already a provider)
   - If already a provider: show "Provider" badge and a "You're a provider!" status
4. Keep existing sign-out button
5. Keep the warm orange/amber styling

Layout update: Transform the current minimal dashboard into a more useful hub:
```
<Welcome header with name>
{!username && <UsernamePromptBanner />}
<Navigation cards grid>
  - Edit Profile card
  - View Profile card (if username exists)
  - Become a Provider card (if !isProvider)
  - Provider status badge (if isProvider)
</Navigation cards grid>
<Sign out button>
```

Each nav card: white bg, rounded-lg, shadow, hover:shadow-md transition, icon or emoji (optional), title, brief description. Orange accent on hover.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no errors
2. Run `npm run build` — builds successfully
3. Log in, visit `/dashboard`:
   - If no username: see setup prompt banner
   - See navigation cards for Edit Profile, View Profile, Become a Provider
4. After becoming a provider: "Become a Provider" card hidden, provider badge shown
5. Visit `/profile/edit` while not logged in — redirected to `/login`
6. Visit `/provider/setup` while not logged in — redirected to `/login`
  </verify>
  <done>Dashboard updated with profile navigation cards, username prompt, and provider status. Middleware protects /profile and /provider routes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 user profile system: edit page with avatar crop and portfolio uploads, public profile page with conditional provider sections, "Become a Provider" flow, and updated dashboard with navigation</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Log in and visit `/dashboard` — should see username setup prompt if not set
3. Click "Edit Profile" → navigate to `/profile/edit`
4. Set username, display name, bio → click Save → data persists on refresh
5. Upload avatar: click avatar area → crop circle modal → confirm → avatar shows
6. Upload 1-2 portfolio images → they appear in grid → delete one
7. Visit `/u/[your-username]` → profile page shows your info (no provider sections yet)
8. Go to `/dashboard` → click "Become a Provider"
9. Fill in provider fields (skills, bio, experience, etc.) → submit
10. Visit `/u/[your-username]` again → provider sections now visible (skills tags, experience, etc.)
11. Visit `/u/nonexistent` → custom 404 page
12. Test on mobile viewport → layout responsive
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `/provider/setup` renders form, saves provider data, sets isProvider to true
2. Dashboard shows username prompt when no username is set
3. Dashboard has navigation cards to edit profile, view profile, become provider
4. Middleware protects `/profile/*` and `/provider/*` routes
5. Provider sections appear on public profile after completing provider setup
6. Full flow works: register → dashboard → edit profile → set username → become provider → view profile
</verification>

<success_criteria>
- "Become a Provider" is an intentional separate flow, not just fields on edit page
- Provider setup requires username to be set first
- Dashboard serves as navigation hub with contextual cards
- Middleware protects all new authenticated routes
- End-to-end flow verified by human: register through provider setup
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-profiles/02-04-SUMMARY.md`
</output>
