---
phase: 02-user-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - package.json
  - next.config.ts
  - src/lib/file-upload.ts
  - src/lib/validations/profile.ts
autonomous: true

must_haves:
  truths:
    - "User model has username, displayName, bio, avatar, isProvider fields"
    - "PortfolioImage model exists with userId relation and imageUrl"
    - "Upload utility can save files to /public/uploads with unique filenames"
    - "Zod schemas validate profile fields including username uniqueness format"
    - "next.config allows Server Actions with increased body size for file uploads"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Extended User model + PortfolioImage model"
      contains: "model PortfolioImage"
    - path: "src/lib/file-upload.ts"
      provides: "File upload utility for saving to local filesystem"
      exports: ["saveFile", "deleteFile"]
    - path: "src/lib/validations/profile.ts"
      provides: "Zod validation schemas for profile data"
      exports: ["profileSchema", "usernameSchema", "providerSchema"]
    - path: "next.config.ts"
      provides: "Server Actions body size limit configuration"
      contains: "bodySizeLimit"
  key_links:
    - from: "prisma/schema.prisma"
      to: "database"
      via: "prisma db push"
      pattern: "model User"
    - from: "src/lib/file-upload.ts"
      to: "public/uploads"
      via: "fs.promises.writeFile"
      pattern: "writeFile"
---

<objective>
Set up the database schema, dependencies, upload infrastructure, and validation schemas for Phase 2 user profiles.

Purpose: All profile features (edit, view, provider setup) depend on the extended schema, upload utilities, and validation. This plan establishes the foundation so Plans 02 and 03 can execute in parallel.
Output: Extended Prisma schema with profile fields, file upload utility, Zod validation schemas, and new npm dependencies installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-profiles/02-CONTEXT.md
@.planning/phases/02-user-profiles/02-RESEARCH.md
@prisma/schema.prisma
@next.config.ts
@package.json
@src/lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure Next.js for file uploads</name>
  <files>package.json, next.config.ts</files>
  <action>
Install new dependencies:
```bash
npm install react-easy-crop swiper file-type
npm install -D @types/react-easy-crop
```

Note: `react-easy-crop` is for avatar circle crop UI (Plan 02), `swiper` is for portfolio carousel (Plan 03), `file-type` is for magic byte validation in uploads.

Update `next.config.ts` to increase Server Actions body size limit for file uploads:
```ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  experimental: {
    serverActions: {
      bodySizeLimit: "5mb",
    },
  },
  images: {
    remotePatterns: [],
  },
};

export default nextConfig;
```

The 5mb limit accommodates avatar and portfolio image uploads via Server Actions.
  </action>
  <verify>
Run `npm ls react-easy-crop swiper file-type` — all three resolve without errors.
Verify `next.config.ts` contains `bodySizeLimit: "5mb"`.
  </verify>
  <done>Dependencies installed, next.config configured for file uploads.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Prisma schema with profile fields and PortfolioImage model</name>
  <files>prisma/schema.prisma</files>
  <action>
Extend the existing User model with profile fields (do NOT remove existing fields):

```prisma
model User {
  // ... existing fields (id, name, email, emailVerified, image, hashedPassword, accounts, sessions, createdAt, updatedAt)

  // Profile fields (Phase 2)
  username        String?   @unique
  displayName     String?
  bio             String?   @db.Text
  avatarUrl       String?

  // Provider fields (Phase 2)
  isProvider          Boolean  @default(false)
  providerBio         String?  @db.Text
  professionalSummary String?  @db.Text
  skills              String[] @default([])
  yearsOfExperience   Int?
  certifications      String[] @default([])

  // Relations
  portfolioImages PortfolioImage[]
}
```

Add the PortfolioImage model:

```prisma
model PortfolioImage {
  id        String   @id @default(cuid())
  userId    String
  imageUrl  String
  caption   String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
```

After modifying schema, run:
```bash
npx prisma db push
npx prisma generate
```

This uses `db push` for development (no migration files needed for MVP). The `String[]` type maps to Postgres text arrays. `@db.Text` allows long-form bio content.
  </action>
  <verify>
Run `npx prisma db push` — succeeds without errors.
Run `npx prisma studio` briefly to confirm User model has new fields and PortfolioImage table exists.
  </verify>
  <done>User model extended with profile/provider fields, PortfolioImage model created, database synced.</done>
</task>

<task type="auto">
  <name>Task 3: Create file upload utility and Zod validation schemas</name>
  <files>src/lib/file-upload.ts, src/lib/validations/profile.ts</files>
  <action>
**File: `src/lib/file-upload.ts`**

Create a utility for saving uploaded files to the local filesystem:

```ts
import { promises as fs } from "fs";
import path from "path";
import crypto from "crypto";

const UPLOAD_DIR = path.join(process.cwd(), "public", "uploads");

export async function saveFile(
  file: File,
  subDir: "avatars" | "portfolio"
): Promise<string> {
  const dir = path.join(UPLOAD_DIR, subDir);
  await fs.mkdir(dir, { recursive: true });

  const ext = path.extname(file.name) || ".jpg";
  const uniqueName = `${Date.now()}-${crypto.randomBytes(6).toString("hex")}${ext}`;
  const filePath = path.join(dir, uniqueName);

  const buffer = Buffer.from(await file.arrayBuffer());

  // Validate file is an image by checking magic bytes
  const { fileTypeFromBuffer } = await import("file-type");
  const type = await fileTypeFromBuffer(buffer);
  if (!type || !type.mime.startsWith("image/")) {
    throw new Error("Invalid file type. Only images are allowed.");
  }

  await fs.writeFile(filePath, buffer);
  return `/uploads/${subDir}/${uniqueName}`;
}

export async function deleteFile(fileUrl: string): Promise<void> {
  if (!fileUrl.startsWith("/uploads/")) return;
  const filePath = path.join(process.cwd(), "public", fileUrl);
  try {
    await fs.unlink(filePath);
  } catch {
    // File may not exist, ignore
  }
}
```

Key decisions:
- Unique filenames with timestamp + random hex to prevent collisions
- Magic byte validation via `file-type` for security (not just extension check)
- `deleteFile` silently handles missing files (idempotent)
- Returns URL path relative to `/public` for direct serving

**File: `src/lib/validations/profile.ts`**

Create Zod schemas for profile validation:

```ts
import { z } from "zod";

export const usernameSchema = z
  .string()
  .min(3, "Username must be at least 3 characters")
  .max(30, "Username must be at most 30 characters")
  .regex(
    /^[a-zA-Z0-9_-]+$/,
    "Username can only contain letters, numbers, underscores, and hyphens"
  )
  .transform((val) => val.toLowerCase());

export const profileSchema = z.object({
  username: usernameSchema,
  displayName: z
    .string()
    .min(1, "Display name is required")
    .max(50, "Display name must be at most 50 characters"),
  bio: z
    .string()
    .max(500, "Bio must be at most 500 characters")
    .optional()
    .or(z.literal("")),
});

export const providerSchema = z.object({
  providerBio: z
    .string()
    .min(10, "Provider bio must be at least 10 characters")
    .max(1000, "Provider bio must be at most 1000 characters"),
  professionalSummary: z
    .string()
    .min(10, "Professional summary must be at least 10 characters")
    .max(500, "Professional summary must be at most 500 characters"),
  skills: z
    .array(z.string().min(1).max(50))
    .min(1, "Add at least one skill")
    .max(20, "Maximum 20 skills"),
  yearsOfExperience: z
    .number()
    .int()
    .min(0, "Years of experience cannot be negative")
    .max(50, "Maximum 50 years"),
  certifications: z
    .array(z.string().min(1).max(100))
    .max(10, "Maximum 10 certifications")
    .optional()
    .default([]),
});
```

The schemas enforce:
- Username: 3-30 chars, alphanumeric + underscore/hyphen, lowercased
- Display name: required, max 50 chars
- Bio: optional, max 500 chars
- Provider fields: all required with reasonable limits when becoming a provider
- Skills: array of strings, at least 1 required
- Certifications: optional array
  </action>
  <verify>
Verify both files exist and have no TypeScript errors:
```bash
npx tsc --noEmit
```
Confirm `src/lib/file-upload.ts` exports `saveFile` and `deleteFile`.
Confirm `src/lib/validations/profile.ts` exports `usernameSchema`, `profileSchema`, `providerSchema`.
  </verify>
  <done>File upload utility saves images to /public/uploads with magic byte validation. Zod schemas validate username, profile, and provider data.</done>
</task>

</tasks>

<verification>
1. `npm ls react-easy-crop swiper file-type` — all resolve
2. `npx prisma db push` — succeeds (schema synced)
3. `npx tsc --noEmit` — no TypeScript errors
4. `next.config.ts` has `bodySizeLimit: "5mb"`
5. User model in schema.prisma has: username, displayName, bio, avatarUrl, isProvider, providerBio, professionalSummary, skills, yearsOfExperience, certifications, portfolioImages
6. PortfolioImage model exists with userId relation
</verification>

<success_criteria>
- Extended User model with all profile + provider fields pushed to database
- PortfolioImage model created and synced
- react-easy-crop, swiper, file-type installed
- File upload utility handles save/delete with image validation
- Zod schemas cover username, profile, and provider data
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-profiles/02-01-SUMMARY.md`
</output>
