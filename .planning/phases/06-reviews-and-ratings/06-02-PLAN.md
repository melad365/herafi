---
phase: 06-reviews-and-ratings
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/reviews/StarRating.tsx
  - src/components/reviews/RatingInput.tsx
  - src/components/reviews/ReviewForm.tsx
  - src/components/reviews/ReviewList.tsx
  - src/app/gigs/[slug]/page.tsx
  - src/app/u/[username]/page.tsx
  - src/app/orders/[orderId]/page.tsx
  - src/components/gigs/ProviderCard.tsx
  - src/components/gigs/GigCard.tsx
autonomous: true

must_haves:
  truths:
    - "User can leave a star rating (1-5) and written review after service completion"
    - "Reviews appear on provider profile page"
    - "Reviews appear on gig detail page"
    - "Provider's aggregate rating displays correctly on profile and gig pages"
    - "Review form only shows for completed orders where buyer has not yet reviewed"
    - "Star rating placeholder on ProviderCard shows real aggregate data"
  artifacts:
    - path: "src/components/reviews/StarRating.tsx"
      provides: "Reusable star display component with fractional support"
      exports: ["StarRating"]
    - path: "src/components/reviews/RatingInput.tsx"
      provides: "Interactive star rating selector with hover states"
      exports: ["RatingInput"]
    - path: "src/components/reviews/ReviewForm.tsx"
      provides: "Review submission form using useActionState"
      exports: ["ReviewForm"]
    - path: "src/components/reviews/ReviewList.tsx"
      provides: "Review display list with avatar, name, date, rating, content"
      exports: ["ReviewList"]
  key_links:
    - from: "src/components/reviews/ReviewForm.tsx"
      to: "src/actions/reviews.ts"
      via: "useActionState with submitReview server action"
      pattern: "useActionState.*submitReview"
    - from: "src/app/gigs/[slug]/page.tsx"
      to: "src/components/reviews/ReviewList.tsx"
      via: "Fetches reviews and passes to ReviewList"
      pattern: "ReviewList"
    - from: "src/app/u/[username]/page.tsx"
      to: "src/components/reviews/ReviewList.tsx"
      via: "Fetches provider reviews and passes to ReviewList"
      pattern: "ReviewList"
    - from: "src/app/orders/[orderId]/page.tsx"
      to: "src/components/reviews/ReviewForm.tsx"
      via: "Shows ReviewForm for completed orders without existing review"
      pattern: "ReviewForm"
    - from: "src/components/gigs/ProviderCard.tsx"
      to: "real aggregate rating data"
      via: "Props receive averageRating and totalReviews from database"
      pattern: "averageRating|totalReviews"
---

<objective>
Create review UI components and integrate reviews into existing pages (gig detail, provider profile, order detail).

Purpose: Completes the user-facing review experience. Users can submit reviews on completed orders, see reviews on gig and profile pages, and view real aggregate ratings replacing the "0.0" placeholder.

Output: StarRating, RatingInput, ReviewForm, ReviewList components. Gig detail page shows reviews section. Provider profile shows reviews. Order detail shows review form for eligible orders. ProviderCard and GigCard show real aggregate ratings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reviews-and-ratings/06-RESEARCH.md
@.planning/phases/06-reviews-and-ratings/06-01-SUMMARY.md
@src/components/gigs/ProviderCard.tsx
@src/components/gigs/GigCard.tsx
@src/components/gigs/GigDetailView.tsx
@src/app/gigs/[slug]/page.tsx
@src/app/u/[username]/page.tsx
@src/app/orders/[orderId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review display and input components</name>
  <files>src/components/reviews/StarRating.tsx, src/components/reviews/RatingInput.tsx, src/components/reviews/ReviewList.tsx, src/components/reviews/ReviewForm.tsx</files>
  <action>
Create `src/components/reviews/StarRating.tsx`:
- Props: rating (number), size ("sm" | "md" | "lg"), showNumber (boolean, default false), reviewCount (optional number)
- Renders 5 stars using unicode "★" character — full stars in text-yellow-500, empty in text-gray-300
- Support fractional ratings (e.g., 4.5 shows half star via CSS overflow trick)
- Size classes: sm=text-sm, md=text-lg, lg=text-2xl
- If showNumber, display rating.toFixed(1) next to stars
- If reviewCount provided, show "(N reviews)" text
- Use the orange/amber warm color scheme (text-yellow-500 for filled stars matches existing ProviderCard placeholder)

Create `src/components/reviews/RatingInput.tsx` (client component):
- Props: name (string), value (number), onChange ((value: number) => void), error (optional string)
- "use client" directive
- useState for hoverRating
- Render 5 clickable star buttons with hover preview (onMouseEnter/onMouseLeave)
- Hidden input with name prop for form submission
- Display error message if provided
- Accessible: aria-label="Rate N stars" on each button
- Stars: text-3xl, filled=text-yellow-500, empty=text-gray-300, hover=text-yellow-400

Create `src/components/reviews/ReviewList.tsx`:
- Props: reviews array with { id, rating, content, createdAt, buyer: { username, displayName, avatarUrl } }
- Empty state: "No reviews yet" message
- Each review: white card with border, avatar (image or initials fallback with orange gradient), name, date (format with date-fns "MMMM d, yyyy"), StarRating component, content text
- Follow existing component patterns (ProviderCard, OrderCard styling)

Create `src/components/reviews/ReviewForm.tsx` (client component):
- "use client" directive
- Props: orderId (string)
- Uses useActionState with submitReview.bind(null, orderId) as the action
- Uses RatingInput for star selection (controlled via useState)
- Textarea for content (optional, placeholder "Share your experience...")
- Submit button with pending state (useFormStatus or check state)
- Display success message after submission
- Display error messages from server action (both general errors and field errors)
- Orange/amber themed submit button matching project color scheme
  </action>
  <verify>Run `npx tsc --noEmit` to confirm all components compile. Verify each file exports its named component. Check that ReviewForm imports submitReview from @/actions/reviews.</verify>
  <done>Four review components created: StarRating (display), RatingInput (interactive selector), ReviewList (review cards), ReviewForm (submission form with useActionState).</done>
</task>

<task type="auto">
  <name>Task 2: Integrate reviews into gig detail, provider profile, and order detail pages</name>
  <files>src/app/gigs/[slug]/page.tsx, src/app/u/[username]/page.tsx, src/app/orders/[orderId]/page.tsx, src/components/gigs/ProviderCard.tsx, src/components/gigs/GigCard.tsx</files>
  <action>
Update `src/app/gigs/[slug]/page.tsx`:
- Add to the Prisma query: include reviews with buyer (username, displayName, avatarUrl), and select gig.averageRating, gig.totalReviews
- Add a "Reviews" section below existing content with StarRating showing aggregate and ReviewList showing individual reviews
- Sort reviews by createdAt desc (most recent first)

Update `src/app/u/[username]/page.tsx`:
- Add to the Prisma query: include user.reviewsReceived with buyer info, and select user.averageRating, user.totalReviews
- Add a "Reviews" section to provider profile page with StarRating aggregate and ReviewList
- Sort reviews by createdAt desc

Update `src/app/orders/[orderId]/page.tsx`:
- Add to the Prisma query: include order.review to check if already reviewed
- If order.status === "COMPLETED" AND order.buyerId === session.user.id AND !order.review:
  Show ReviewForm component with orderId
- If order.review exists: Show the existing review with StarRating and content (read-only)

Update `src/components/gigs/ProviderCard.tsx`:
- Replace hardcoded "★ 0.0" placeholder with StarRating component
- Accept averageRating and totalReviews as props (with defaults of 0.0 and 0)
- Show real aggregate data: StarRating with showNumber and reviewCount

Update `src/components/gigs/GigCard.tsx`:
- If GigCard currently shows any rating placeholder, replace with StarRating component
- Accept averageRating and totalReviews props
- Show aggregate rating if totalReviews > 0, otherwise show "New" or no rating

IMPORTANT: When updating existing pages, preserve ALL existing functionality. Only ADD the reviews sections. Read each file carefully before editing to understand existing structure.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to verify the full build succeeds. Visually verify the pages render without errors by checking the dev server.</verify>
  <done>Reviews section appears on gig detail page with aggregate rating and individual reviews. Reviews section appears on provider profile page. Order detail page shows ReviewForm for eligible completed orders or displays existing review. ProviderCard and GigCard show real aggregate ratings instead of placeholder.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no type errors
2. `npm run build` succeeds — all pages build correctly
3. Gig detail page shows "Reviews" section with aggregate rating and review list
4. Provider profile page shows "Reviews" section with aggregate rating and review list
5. Order detail page shows ReviewForm when order is COMPLETED, buyer is viewer, and no review exists
6. Order detail page shows existing review read-only when review already submitted
7. ProviderCard shows real averageRating instead of hardcoded "0.0"
8. ReviewForm submits via useActionState and shows success/error feedback
</verification>

<success_criteria>
- All four review components created and compile without errors
- Gig detail page displays reviews and aggregate rating
- Provider profile page displays reviews and aggregate rating
- Order detail page conditionally shows ReviewForm or existing review
- ProviderCard and GigCard display real aggregate data
- Full build passes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06-reviews-and-ratings/06-02-SUMMARY.md`
</output>
