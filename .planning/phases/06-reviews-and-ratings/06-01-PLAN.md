---
phase: 06-reviews-and-ratings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/review.ts
  - src/actions/reviews.ts
autonomous: true

must_haves:
  truths:
    - "Review model exists in database with buyerId, orderId, providerId, gigId, rating, content fields"
    - "User and Gig models have denormalized averageRating and totalReviews fields"
    - "Review submission validates rating 1-5, optional content min 10 chars"
    - "Only buyers of COMPLETED orders can submit reviews"
    - "Aggregate ratings recalculate atomically within a transaction"
    - "Duplicate reviews per order are prevented at database level"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Review model with composite unique constraint, aggregate fields on User and Gig"
      contains: "model Review"
    - path: "src/lib/validations/review.ts"
      provides: "Zod validation schema for review form data"
      exports: ["reviewSchema", "ReviewFormData"]
    - path: "src/actions/reviews.ts"
      provides: "submitReview server action with verified purchase check and transactional aggregates"
      exports: ["submitReview", "ReviewActionState"]
  key_links:
    - from: "src/actions/reviews.ts"
      to: "prisma.review.create"
      via: "transactional review creation with aggregate recalculation"
      pattern: "prisma\\.\\$transaction"
    - from: "src/actions/reviews.ts"
      to: "src/lib/validations/review.ts"
      via: "Zod schema validation"
      pattern: "reviewSchema\\.safeParse"
    - from: "prisma/schema.prisma"
      to: "Review model"
      via: "composite unique constraint"
      pattern: "@@unique\\(\\[buyerId, orderId\\]\\)"
---

<objective>
Create the Review data model, validation schema, and server action for submitting reviews on completed orders.

Purpose: Establishes the data foundation and business logic for the reviews & ratings feature. Reviews are linked to verified completed orders, with denormalized aggregate ratings on User and Gig models for fast display.

Output: Review model in Prisma schema (migrated), Zod validation schema, submitReview server action with verified purchase checks and transactional aggregate updates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reviews-and-ratings/06-RESEARCH.md
@prisma/schema.prisma
@src/actions/orders.ts
@src/lib/validations/order.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Review model and aggregate fields to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the Review model to the Prisma schema with these fields:
- id: String @id @default(cuid())
- buyerId: String (relation to User "BuyerReviews", onDelete: Cascade)
- orderId: String (relation to Order, onDelete: Cascade)
- providerId: String (relation to User "ProviderReviews", onDelete: Cascade)
- gigId: String (relation to Gig, onDelete: Cascade)
- rating: Int (1-5 stars)
- content: String? @db.Text
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt
- @@unique([buyerId, orderId]) — one review per buyer per order
- @@index([providerId]), @@index([gigId]), @@index([createdAt])

Add to existing User model:
- averageRating: Float @default(0.0)
- totalReviews: Int @default(0)
- reviewsWritten: Review[] @relation("BuyerReviews")
- reviewsReceived: Review[] @relation("ProviderReviews")

Add to existing Gig model:
- averageRating: Float @default(0.0)
- totalReviews: Int @default(0)
- reviews: Review[]

Add to existing Order model:
- review: Review? (one-to-one: order can have at most one review)

Run `npx prisma db push` to apply the schema changes.

IMPORTANT: Preserve all existing model fields and relations. Only ADD new fields and the new Review model.
  </action>
  <verify>Run `npx prisma db push` successfully. Run `npx prisma validate` to confirm schema is valid. Check that Review model appears in generated client types.</verify>
  <done>Review model exists in schema with composite unique constraint, User and Gig have averageRating/totalReviews fields, Order has optional review relation, database migrated successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Create review validation schema and submitReview server action</name>
  <files>src/lib/validations/review.ts, src/actions/reviews.ts</files>
  <action>
Create `src/lib/validations/review.ts`:
- Export reviewSchema: z.object with rating (z.number().int().min(1).max(5)) and content (z.string().min(10).max(1000).optional().nullable())
- Export ReviewFormData type

Create `src/actions/reviews.ts`:
- "use server" directive
- Export ReviewActionState type: { success: boolean; reviewId?: string; error?: string; fieldErrors?: Record<string, string[]> }
- Export submitReview(orderId: string, _prevState: ReviewActionState, formData: FormData):
  1. Auth check via auth() — return error if not authenticated
  2. Fetch order with id, status, buyerId, providerId, gigId
  3. Verify order exists, buyer is current user, status is COMPLETED
  4. Check for existing review via findUnique with buyerId_orderId composite key
  5. Parse formData: rating as parseInt, content as string|null
  6. Validate with reviewSchema.safeParse — return fieldErrors on failure
  7. Use prisma.$transaction(async (tx) => { ... }) to:
     a. Create review with all fields
     b. Fetch all provider reviews, compute average, update user.averageRating and user.totalReviews
     c. Fetch all gig reviews, compute average, update gig.averageRating and gig.totalReviews
  8. Handle P2002 error (unique constraint violation) gracefully
  9. revalidatePath for /orders/[orderId], /gigs/[gigId], and /u/[username] (fetch provider username)
  10. Return { success: true, reviewId }

Follow the existing server action patterns from src/actions/orders.ts (auth check, prisma queries, error handling).
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify the file exports submitReview and ReviewActionState. Check that the server action imports auth, prisma, reviewSchema correctly.</verify>
  <done>reviewSchema validates rating 1-5 and optional content min 10 chars. submitReview server action checks auth, verifies completed order ownership, prevents duplicates, creates review in transaction with aggregate recalculation, and revalidates paths.</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes — schema is valid
2. `npx tsc --noEmit` passes — no type errors in new files
3. Review model has @@unique([buyerId, orderId]) constraint
4. User and Gig models have averageRating (Float, default 0.0) and totalReviews (Int, default 0)
5. submitReview checks: auth, order exists, buyer ownership, COMPLETED status, no duplicate
6. Aggregate recalculation happens inside prisma.$transaction
</verification>

<success_criteria>
- Review model exists in database with all fields and constraints
- Validation schema enforces rating 1-5 and optional content min 10 chars
- Server action prevents unauthorized, non-completed, and duplicate reviews
- Aggregate ratings update atomically via transaction
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-reviews-and-ratings/06-01-SUMMARY.md`
</output>
