---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(auth)/layout.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/register/page.tsx
  - src/app/(auth)/components/auth-form.tsx
  - src/app/dashboard/page.tsx
  - middleware.ts
autonomous: false

must_haves:
  truths:
    - "User can create account via register page with name, email, password"
    - "User can log in via login page with email and password"
    - "User is redirected to dashboard after successful login/registration"
    - "Unauthenticated user is redirected to login when accessing dashboard"
    - "Authenticated user is redirected to dashboard when accessing login/register"
    - "User sees validation errors for invalid input (client-side)"
    - "User sees error message for wrong credentials or duplicate email"
    - "Session persists across browser refresh"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form page with email and password fields"
    - path: "src/app/(auth)/register/page.tsx"
      provides: "Registration form page with name, email, and password fields"
    - path: "src/app/(auth)/components/auth-form.tsx"
      provides: "Shared form components for auth pages (optional — reusable input styling)"
    - path: "src/app/dashboard/page.tsx"
      provides: "Protected dashboard page showing user name and email"
    - path: "middleware.ts"
      provides: "Route protection redirecting unauthenticated users"
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/actions/auth.ts"
      via: "loginUser server action call"
      pattern: "loginUser"
    - from: "src/app/(auth)/register/page.tsx"
      to: "src/actions/auth.ts"
      via: "registerUser server action call"
      pattern: "registerUser"
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/lib/validations/auth.ts"
      via: "loginSchema for client validation"
      pattern: "loginSchema"
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/auth.ts"
      via: "auth() session check"
      pattern: "await auth\\(\\)"
    - from: "middleware.ts"
      to: "src/lib/auth.ts"
      via: "auth middleware wrapper"
      pattern: "auth.*middleware"
---

<objective>
Build the login and registration UI pages with React Hook Form + Zod validation, create a protected dashboard page, and implement middleware-based route protection. This completes the full auth flow end-to-end.

Purpose: This is where users actually interact with the auth system. Without UI and route protection, the backend auth logic is unusable.
Output: Working login/register pages, protected dashboard, and middleware that enforces authentication boundaries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth pages (login, register) with React Hook Form</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/register/page.tsx
  </files>
  <action>
    Create `src/app/(auth)/layout.tsx` — a centered layout for auth pages:
    - Full viewport height, centered content (flexbox)
    - Clean background, max-width container (~400px)
    - "Herafi" branding at top (text logo, warm tone)
    - Keep it minimal but polished — not template-looking
    - Use Tailwind for all styling

    Create `src/app/(auth)/register/page.tsx` — "use client" component:
    - Import useForm from react-hook-form, zodResolver from @hookform/resolvers/zod
    - Import registerSchema and RegisterInput from @/lib/validations/auth
    - Import registerUser from @/actions/auth
    - Import useRouter from next/navigation, useState for error state

    Form fields:
    - Name input (text)
    - Email input (email)
    - Password input (password)

    Behavior:
    - useForm with zodResolver(registerSchema) for client-side validation
    - On submit: call registerUser({ name, email, password })
    - Show field-level errors from Zod validation below each input
    - Show server error (duplicate email, etc.) as a general alert above form
    - Disable submit button while isSubmitting, show "Creating account..." text
    - On success: router.push("/dashboard") — also call router.refresh() to update server state
    - Link to "/login" at bottom: "Already have an account? Sign in"

    Styling direction (Tailwind):
    - Rounded inputs with focus ring (warm color — amber/orange family)
    - Subtle border, padding, spacing
    - Button: solid warm color, rounded, hover state with slight darkening
    - Error text in red/rose below fields
    - General error in a styled alert box
    - Clean font sizing, good spacing between fields

    Create `src/app/(auth)/login/page.tsx` — similar structure but:
    - Only email and password fields (no name)
    - Uses loginSchema and LoginInput
    - Calls loginUser({ email, password })
    - Error message: generic "Invalid email or password" (from server action)
    - Link to "/register" at bottom: "Don't have an account? Sign up"
    - Same styling as register page for consistency
  </action>
  <verify>
    Run `npm run build` — should compile without errors.
    Confirm all three files exist and are valid React components.
    Confirm "use client" directive on login and register pages.
  </verify>
  <done>
    Login page at /login with email + password fields, client-side Zod validation, calls loginUser server action, shows errors, redirects to /dashboard on success. Register page at /register with name + email + password fields, client-side Zod validation, calls registerUser, shows field and server errors, redirects to /dashboard on success. Both pages share consistent warm, polished Tailwind styling. Auth layout centers content with branding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create protected dashboard and middleware route protection</name>
  <files>
    src/app/dashboard/page.tsx
    middleware.ts
  </files>
  <action>
    Create `middleware.ts` in project root (NOT src/):
    - Import auth from "@/lib/auth"
    - Use the Auth.js middleware pattern: `export default auth((req) => { ... })`
    - Define route logic:
      - isAuthPage: pathname starts with "/login" or "/register"
      - isProtectedPage: pathname starts with "/dashboard"
      - If authenticated + on auth page: redirect to "/dashboard"
      - If not authenticated + on protected page: redirect to "/login"
      - Otherwise: NextResponse.next()
    - Export config.matcher to exclude static files, API routes, and _next:
      ```
      matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"]
      ```

    NOTE: Auth.js v5 middleware export pattern. If `export default auth(...)` doesn't work as middleware, use the alternative pattern:
    ```typescript
    export { auth as middleware } from "@/lib/auth"
    ```
    And handle redirects in the `authorized` callback within the Auth.js config instead. The executor should try the inline approach first and fall back if needed.

    Create `src/app/dashboard/page.tsx` — Server Component:
    - Import auth from "@/lib/auth"
    - Import redirect from "next/navigation"
    - Call `const session = await auth()`
    - If no session: redirect("/login") — defense in depth (middleware should catch this first)
    - Display: "Welcome, {session.user.name}!" with user's email
    - Add a sign-out button/form that calls signOut. Use a form with action that calls the signOut server action, or a client component with signOut.
    - Include a simple sign-out mechanism: create a small client component or use a form action that calls signOut from next-auth/react or from the server action.
    - Keep the dashboard minimal — just proves auth works. Show user info and sign-out.
    - Tailwind styling: clean card layout, warm tones consistent with auth pages
  </action>
  <verify>
    Run `npm run build` — should compile without errors.
    Confirm middleware.ts exists at project root.
    Confirm dashboard page exists and imports auth.
  </verify>
  <done>
    Middleware redirects unauthenticated users from /dashboard to /login, and authenticated users from /login and /register to /dashboard. Dashboard Server Component displays user name and email from session, with sign-out functionality. Defense-in-depth: both middleware and Server Component check auth state.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete auth flow</name>
  <what-built>Complete authentication system: register, login, session persistence, route protection, sign-out</what-built>
  <how-to-verify>
    Prerequisites: Ensure PostgreSQL is running locally with a "herafi" database. Run `npx prisma db push` if not already done.

    1. Start dev server: `npm run dev`
    2. Visit http://localhost:3000/dashboard — should redirect to /login
    3. Click "Don't have an account? Sign up" — should navigate to /register
    4. Try submitting empty form — should see client-side validation errors
    5. Try a weak password like "abc" — should see password requirement errors
    6. Register with valid data (name, email, strong password) — should redirect to /dashboard
    7. Dashboard should show your name and email
    8. Refresh the page — should still be on dashboard (session persists)
    9. Sign out — should redirect to /login
    10. Try logging in with wrong password — should see "Invalid email or password"
    11. Log in with correct credentials — should reach dashboard
    12. Close browser tab, reopen http://localhost:3000/dashboard — should still be logged in (session persists across browser close)
    13. Visit /login while logged in — should redirect to /dashboard
  </how-to-verify>
  <resume-signal>Type "approved" if all steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Register flow: form validation + user creation + auto-login + redirect
3. Login flow: form validation + authentication + redirect
4. Session persistence: refresh page, reopen browser — still authenticated
5. Route protection: unauthenticated → /login, authenticated → /dashboard
6. Error handling: validation errors, wrong credentials, duplicate email
7. Sign-out: clears session, redirects to login
</verification>

<success_criteria>
- User can register with name, email, and strong password via /register
- User can log in with email and password via /login
- Invalid inputs show client-side validation errors instantly
- Wrong credentials show generic "Invalid email or password"
- Duplicate email shows appropriate error on registration
- Session persists across page refresh and browser restart (AUTH-03)
- Middleware protects /dashboard from unauthenticated access
- Middleware redirects authenticated users away from /login and /register
- Dashboard shows user info and provides sign-out
- All AUTH-01, AUTH-02, AUTH-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
