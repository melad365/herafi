---
phase: 07-provider-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/provider/dashboard/_components/MessagesTab.tsx
  - src/app/provider/dashboard/page.tsx
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Provider can access message conversations from the Messages tab"
    - "Messages tab shows conversation list with other user info and last message preview"
    - "Dashboard clearly distinguishes between provider mode and buyer mode"
    - "Existing buyer dashboard links to provider dashboard for providers"
    - "Provider dashboard links back to buyer dashboard"
  artifacts:
    - path: "src/app/provider/dashboard/_components/MessagesTab.tsx"
      provides: "Conversation list for provider's messages with links to chat"
      min_lines: 30
    - path: "src/app/provider/dashboard/page.tsx"
      provides: "Updated to import and render MessagesTab"
      contains: "MessagesTab"
    - path: "src/app/dashboard/page.tsx"
      provides: "Updated buyer dashboard with link to provider dashboard"
      contains: "provider/dashboard"
  key_links:
    - from: "src/app/provider/dashboard/_components/MessagesTab.tsx"
      to: "/messages/[conversationId]"
      via: "Link href to existing chat pages"
      pattern: "href.*messages"
    - from: "src/app/dashboard/page.tsx"
      to: "/provider/dashboard"
      via: "Link for providers to access provider dashboard"
      pattern: "provider/dashboard"
---

<objective>
Complete the provider dashboard with MessagesTab and update navigation between buyer/provider modes.

Purpose: Completes the provider dashboard experience by adding message access and creating clear navigation paths between buyer mode (/dashboard) and provider mode (/provider/dashboard). This fulfills the "clear role distinction" success criterion.

Output: MessagesTab component, updated provider dashboard page importing it, and updated buyer dashboard with provider dashboard link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-provider-dashboard/07-RESEARCH.md
@.planning/phases/07-provider-dashboard/07-01-SUMMARY.md

Key existing files to reference:
@src/app/messages/page.tsx (existing messages page - reuse conversation enrichment pattern)
@src/app/provider/dashboard/page.tsx (created in Plan 01 - update to import MessagesTab)
@src/app/dashboard/page.tsx (existing buyer dashboard - add provider dashboard link)
@src/components/chat/ConversationList.tsx (existing conversation list component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessagesTab component</name>
  <files>
    src/app/provider/dashboard/_components/MessagesTab.tsx
  </files>
  <action>
    **MessagesTab** (`src/app/provider/dashboard/_components/MessagesTab.tsx`):
    - Server Component (no 'use client')
    - Accept `conversations` prop typed as array of:
      ```
      {
        id: string
        otherUser: { id: string; name: string | null; displayName: string | null; avatarUrl: string | null } | null
        lastMessage: { content: string; createdAt: Date; sender: { id: string; name: string | null; displayName: string | null } } | null
        lastMessageAt: Date
      }
      ```
    - Import Link from 'next/link', format from 'date-fns'
    - **Empty state**: If conversations.length === 0, show centered message "No conversations yet." with subtitle "When you chat with buyers, conversations will appear here."
    - **Conversation list**: White rounded-lg shadow-lg p-6
      - Header: h2 "Messages ({conversations.length})" + "View All Messages" link to /messages (text-sm text-orange-600)
      - Each conversation as a Link to `/messages/{conversation.id}`:
        - Flex row with p-4 border rounded-lg hover:border-orange-300 transition-colors
        - Left: Avatar circle (40x40, bg-orange-100 text-orange-600 with first letter of name, or actual avatar if avatarUrl exists via img tag)
        - Middle: Other user's displayName || name || "Anonymous" (font-semibold), last message content preview (text-sm text-gray-600 truncate, max 60 chars)
        - Right: Relative time of lastMessageAt using format(date, 'MMM d') from date-fns
    - Show max 10 conversations with "View all messages" link at bottom if more exist
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors.
    MessagesTab component renders conversation list with links to chat pages.
  </verify>
  <done>
    MessagesTab shows provider's conversations with user avatars, last message preview, and timestamps. Each conversation links to the full chat page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire MessagesTab into dashboard and update buyer dashboard navigation</name>
  <files>
    src/app/provider/dashboard/page.tsx
    src/app/dashboard/page.tsx
  </files>
  <action>
    **Update provider dashboard page** (`src/app/provider/dashboard/page.tsx`):
    - Add conversation fetching to the existing Promise.all():
      - Query prisma.conversation.findMany where participantIds has session.user.id
      - orderBy lastMessageAt desc, take 10
      - Include messages (take 1, orderBy createdAt desc, include sender with id, name, displayName, avatarUrl)
    - After the Promise.all, enrich conversations with other participant info (same pattern as /messages/page.tsx):
      - For each conversation, find otherUserId from participantIds
      - Fetch otherUser details (id, name, displayName, avatarUrl)
      - Map to { id, otherUser, lastMessage, lastMessageAt } shape
    - Import MessagesTab from './_components/MessagesTab'
    - Render MessagesTab when activeTab === 'messages', passing enrichedConversations

    **Update buyer dashboard** (`src/app/dashboard/page.tsx`):
    - Add a "Provider Dashboard" navigation card in the grid section for providers (user?.isProvider):
      - Link to /provider/dashboard
      - Styled like existing cards but with orange gradient (bg-gradient-to-br from-orange-50 to-amber-50, border-orange-200)
      - Title: "Provider Dashboard"
      - Subtitle: "Manage your gigs, orders, and messages"
    - Place it as the first card in the navigation grid for providers (before Messages card)
    - This creates the clear buyer-to-provider navigation path
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors.
    Visit /provider/dashboard?tab=messages - conversations listed with links to chat.
    Visit /dashboard as provider - "Provider Dashboard" card visible, links to /provider/dashboard.
    Visit /provider/dashboard - "Switch to Buyer Mode" link goes to /dashboard.
  </verify>
  <done>
    MessagesTab renders in provider dashboard with conversation data. Buyer dashboard has "Provider Dashboard" card for providers. Clear bidirectional navigation between buyer and provider modes exists.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. /provider/dashboard?tab=messages shows conversation list
3. Each conversation links to /messages/{conversationId} for full chat
4. /dashboard shows "Provider Dashboard" card for provider users
5. /provider/dashboard has "Switch to Buyer Mode" linking to /dashboard
6. Non-provider users don't see "Provider Dashboard" card on /dashboard
7. Empty states display correctly when no conversations exist
</verification>

<success_criteria>
- MessagesTab shows provider's conversations with user info and last message preview
- Provider dashboard fully functional with all 3 tabs (gigs, orders, messages)
- Clear bidirectional navigation: /dashboard <-> /provider/dashboard
- Provider users see "Provider Dashboard" card on buyer dashboard
- Role distinction is clear: buyer dashboard = "my orders, browse", provider dashboard = "my gigs, incoming orders, messages"
</success_criteria>

<output>
After completion, create `.planning/phases/07-provider-dashboard/07-02-SUMMARY.md`
</output>
