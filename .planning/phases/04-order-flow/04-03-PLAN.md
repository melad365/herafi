---
phase: 04-order-flow
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/app/gigs/[slug]/page.tsx
  - src/app/gigs/[slug]/order/page.tsx
  - src/components/orders/OrderStatusBadge.tsx
  - src/components/orders/OrderCard.tsx
  - src/components/orders/OrderTimeline.tsx
  - src/app/orders/page.tsx
  - src/app/orders/[orderId]/page.tsx
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can select a tier and place an order from the gig detail page"
    - "User sees mock payment confirmation before order is placed"
    - "Buyer can view their order history at /orders"
    - "Both buyer and provider can view order details at /orders/[orderId]"
    - "Provider sees incoming order requests on dashboard"
    - "Buyer sees their orders on dashboard"
    - "Provider can accept, start, and complete orders from order detail page"
    - "Order progresses through visual states: Pending -> Accepted -> In Progress -> Completed"
  artifacts:
    - path: "src/app/gigs/[slug]/order/page.tsx"
      provides: "Order placement page with tier selection and mock payment"
      min_lines: 80
    - path: "src/components/orders/OrderStatusBadge.tsx"
      provides: "Colored status badge component"
      exports: ["OrderStatusBadge"]
    - path: "src/components/orders/OrderCard.tsx"
      provides: "Order summary card for lists"
      exports: ["OrderCard"]
    - path: "src/components/orders/OrderTimeline.tsx"
      provides: "Visual order state progression timeline"
      exports: ["OrderTimeline"]
    - path: "src/app/orders/page.tsx"
      provides: "Buyer order history list page"
      min_lines: 40
    - path: "src/app/orders/[orderId]/page.tsx"
      provides: "Order detail page with contextual actions"
      min_lines: 80
    - path: "src/app/dashboard/page.tsx"
      provides: "Updated dashboard with buyer orders and provider order requests"
  key_links:
    - from: "src/app/gigs/[slug]/page.tsx"
      to: "src/app/gigs/[slug]/order/page.tsx"
      via: "Order Now link in pricing tier cards"
      pattern: "/gigs/.*slug.*/order"
    - from: "src/app/gigs/[slug]/order/page.tsx"
      to: "src/actions/orders.ts"
      via: "placeOrder action"
      pattern: "placeOrder"
    - from: "src/app/orders/[orderId]/page.tsx"
      to: "src/actions/orders.ts"
      via: "acceptOrder, startOrder, completeOrder, cancelOrder actions"
      pattern: "(acceptOrder|startOrder|completeOrder|cancelOrder)"
    - from: "src/app/dashboard/page.tsx"
      to: "prisma.order"
      via: "order queries for buyer and provider views"
      pattern: "prisma\\.order\\.findMany"
---

<objective>
Build the complete order UI: placement page with mock payment, order list and detail pages, status components, and dashboard integration.

Purpose: This is the user-facing layer — buyers place orders from gig pages, both parties track orders, providers manage order state from the detail page, and the dashboard surfaces order activity.
Output: Order placement page, order list page, order detail page, shared order components, updated dashboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-order-flow/04-RESEARCH.md
@.planning/phases/04-order-flow/04-01-SUMMARY.md
@.planning/phases/04-order-flow/04-02-SUMMARY.md
@src/actions/orders.ts
@src/lib/order-state-machine.ts
@src/lib/validations/pricing.ts
@src/app/gigs/[slug]/page.tsx
@src/app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order components and placement page</name>
  <files>
    src/app/gigs/[slug]/page.tsx
    src/components/orders/OrderStatusBadge.tsx
    src/components/orders/OrderCard.tsx
    src/components/orders/OrderTimeline.tsx
    src/app/gigs/[slug]/order/page.tsx
  </files>
  <action>
Update `src/app/gigs/[slug]/page.tsx`:
- Add an "Order Now" button inside each pricing tier card that links to `/gigs/[slug]/order`
- Use Next.js Link component pointing to `/gigs/${gig.slug}/order`
- Button should be prominent: warm orange theme (bg-orange-500 hover:bg-orange-600 text-white), full width within the tier card, rounded, py-2.5 font-semibold
- Place button at the bottom of each enabled tier card
- Only show the button for authenticated non-owner users (if the viewer is the gig provider, show a muted "Your Gig" label instead)

Create `src/components/orders/OrderStatusBadge.tsx`:
- Import OrderStatus from '@prisma/client'
- STATUS_CONFIG map: each status has label (string) and colorClass (Tailwind classes)
  - PENDING: yellow-100/yellow-800
  - ACCEPTED: blue-100/blue-800
  - IN_PROGRESS: purple-100/purple-800 (label: "In Progress")
  - COMPLETED: green-100/green-800
  - CANCELLED: red-100/red-800
- Export OrderStatusBadge component: renders span with rounded-full pill style

Create `src/components/orders/OrderCard.tsx`:
- Props: order (with id, status, totalPrice, selectedTier, createdAt, gig { title, slug }, and either buyer or provider info), viewAs ('buyer' | 'provider')
- Renders: Link to /orders/[order.id], gig title, status badge, price, tier name, date (use date-fns format), counterparty name (provider if viewAs=buyer, buyer if viewAs=provider)
- Use warm styling consistent with existing cards (bg-white, rounded-lg, shadow, hover:shadow-md transition)

Create `src/components/orders/OrderTimeline.tsx`:
- Props: order with createdAt, acceptedAt?, startedAt?, completedAt?, cancelledAt?
- Build events array from non-null timestamps
- Render vertical timeline with circles and connecting lines
- Each event: label, formatted date (date-fns format 'PPpp'), colored indicator
- Use neutral step indicators (colored circles, not emojis) — green for positive steps, red for cancelled

Create `src/app/gigs/[slug]/order/page.tsx` (server component with client interactive parts):
- This is the order placement page accessed from gig detail
- Async params pattern (await params to get slug) per Next.js 15
- Fetch gig by slug with provider info
- Check auth — redirect to /login if not authenticated
- Check self-ordering — show error if user is the provider
- Display gig title, pricing tiers as selectable cards
- Client component section (inline 'use client' component or separate): tier selection state, mock payment confirmation dialog
- Mock payment flow: user selects tier -> clicks "Continue to Payment" -> modal shows tier name, price, MVP notice ("This is a simulated payment") -> "Confirm Payment" button -> calls placeOrder action via useActionState -> redirect to /orders/[orderId] on success
- Use useActionState (from 'react') with placeOrder.bind(null, slug) pattern
- Show error messages from action state
- Style: consistent with gig detail page warm orange theme
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Check that /gigs/[slug]/order/page.tsx renders without build errors.</verify>
  <done>Order placement page allows tier selection, shows mock payment confirmation, creates order via server action. Shared components render status badges, order cards, and timeline.</done>
</task>

<task type="auto">
  <name>Task 2: Create order list page, detail page, and update dashboard</name>
  <files>
    src/app/orders/page.tsx
    src/app/orders/[orderId]/page.tsx
    src/app/dashboard/page.tsx
  </files>
  <action>
Create `src/app/orders/page.tsx`:
- Server component, requires auth (redirect to /login if not)
- Fetch orders where buyerId = session.user.id, include gig { title, slug } and provider { username, displayName, avatarUrl }
- Order by createdAt desc
- Render page title "My Orders"
- Map orders to OrderCard components with viewAs="buyer"
- Empty state: "You haven't placed any orders yet." with link to /gigs

Create `src/app/orders/[orderId]/page.tsx`:
- Server component with async params (await params for orderId)
- Require auth
- Fetch order by id, include buyer, provider, gig (select relevant fields)
- Authorization: check order.buyerId or order.providerId matches session user — call notFound() if neither
- Determine isBuyer and isProvider booleans
- Display: order header with status badge, gig title (linked), buyer/provider info (linked to /u/username), selected tier name, total price, delivery notes if present
- Provider action buttons (conditional on role and status):
  - PENDING: "Accept Order" (green) + "Decline" (red) — forms with acceptOrder.bind(null, orderId) and cancelOrder.bind(null, orderId)
  - ACCEPTED: "Start Working" (orange) — startOrder.bind(null, orderId)
  - IN_PROGRESS: "Mark Complete" (green) — completeOrder.bind(null, orderId)
- Buyer action: cancel button visible when status is PENDING or ACCEPTED
- OrderTimeline component at bottom showing order progression
- Use format from date-fns for order placed date
- Warm orange theme styling consistent with rest of app

Update `src/app/dashboard/page.tsx`:
- Add Order import from '@prisma/client'
- After existing dashboard queries, add two order queries:
  1. buyerOrders: prisma.order.findMany where buyerId = session.user.id, include gig { title, slug } and provider { username, displayName, avatarUrl }, orderBy createdAt desc, take 5
  2. providerOrders (only if user.isProvider): prisma.order.findMany where providerId = session.user.id AND status in [PENDING, ACCEPTED, IN_PROGRESS], include gig { title, slug } and buyer { username, displayName, avatarUrl }, orderBy createdAt desc
- Add "My Orders" section to dashboard (after existing cards) showing buyerOrders as OrderCard list with viewAs="buyer", with "View All" link to /orders
- Add "Order Requests" section for providers showing providerOrders as OrderCard list with viewAs="provider"
- Both sections: show only if orders exist, render count in heading
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Run `npm run build` — build succeeds. Navigate to /orders, /orders/[id], /dashboard — pages render correctly.</verify>
  <done>Order list shows buyer's orders. Order detail page shows full order info with contextual action buttons. Dashboard displays buyer orders and provider order requests.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. /gigs/[slug]/order page shows tier selection and mock payment flow
3. /orders page lists buyer's orders with status badges
4. /orders/[orderId] page shows order details with action buttons for provider
5. /dashboard shows "My Orders" section for buyers
6. /dashboard shows "Order Requests" section for providers
7. Provider can accept -> start -> complete order from detail page
8. Buyer can cancel pending orders
9. OrderTimeline shows progression timestamps
10. All pages require authentication (redirect to /login)
</verification>

<success_criteria>
- Complete order placement flow: gig page -> tier selection -> mock payment -> order created
- Order appears in buyer's /orders list and dashboard
- Order appears in provider's dashboard "Order Requests"
- Provider can progress order through all states from detail page
- Both buyer and provider can view order details
- Authorization enforced on all pages (only participants can view/act)
- Visual status progression via badges and timeline
</success_criteria>

<output>
After completion, create `.planning/phases/04-order-flow/04-03-SUMMARY.md`
</output>
