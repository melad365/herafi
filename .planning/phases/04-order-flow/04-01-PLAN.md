---
phase: 04-order-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/order-state-machine.ts
  - src/lib/validations/order.ts
autonomous: true

must_haves:
  truths:
    - "Order model exists in database with buyer, provider, and gig relations"
    - "OrderStatus enum defines PENDING, ACCEPTED, IN_PROGRESS, COMPLETED, CANCELLED states"
    - "State transition map validates which status changes are allowed"
    - "Order validation schema validates tier selection input"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Order model and OrderStatus enum"
      contains: "model Order"
    - path: "src/lib/order-state-machine.ts"
      provides: "State transition validation"
      exports: ["canTransition", "validateTransition", "getNextStates", "ORDER_STATE_TRANSITIONS"]
    - path: "src/lib/validations/order.ts"
      provides: "Zod schema for order creation"
      exports: ["orderSchema", "OrderFormData"]
  key_links:
    - from: "prisma/schema.prisma"
      to: "User model"
      via: "BuyerOrders and ProviderOrders relations"
      pattern: '@relation\("BuyerOrders"'
    - from: "prisma/schema.prisma"
      to: "Gig model"
      via: "orders relation"
      pattern: "orders.*Order"
---

<objective>
Add Order model to database schema with state machine validation and order validation schemas.

Purpose: Foundation for the entire order flow — the Order model stores transactions between buyers and providers, the state machine enforces valid status transitions, and validation schemas ensure clean input.
Output: Updated Prisma schema with Order model, state machine utility, and Zod validation schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-order-flow/04-RESEARCH.md
@prisma/schema.prisma
@src/lib/validations/gig.ts
@src/lib/validations/pricing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Order model and OrderStatus enum to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add OrderStatus enum with values: PENDING, ACCEPTED, IN_PROGRESS, COMPLETED, CANCELLED.

Add Order model with these fields:
- id: String @id @default(cuid())
- buyerId: String (FK to User)
- buyer: User @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
- providerId: String (FK to User)
- provider: User @relation("ProviderOrders", fields: [providerId], references: [id], onDelete: Cascade)
- gigId: String (FK to Gig)
- gig: Gig @relation(fields: [gigId], references: [id], onDelete: Cascade)
- selectedTier: String (stores "basic", "standard", or "premium")
- tierSnapshot: Json (full tier details at time of purchase — preserves historical pricing)
- totalPrice: Float
- deliveryNotes: String? @db.Text
- status: OrderStatus @default(PENDING)
- paymentConfirmed: Boolean @default(true) (mock payment auto-approved for MVP)
- createdAt: DateTime @default(now())
- acceptedAt: DateTime?
- startedAt: DateTime?
- completedAt: DateTime?
- cancelledAt: DateTime?
- updatedAt: DateTime @updatedAt

Add indexes: @@index([buyerId]), @@index([providerId]), @@index([gigId]), @@index([status]), @@index([createdAt])

Update User model: Add `buyerOrders Order[] @relation("BuyerOrders")` and `providerOrders Order[] @relation("ProviderOrders")` relations.

Update Gig model: Add `orders Order[]` relation.

Run `npx prisma db push` to apply schema changes.

Install date-fns: `npm install date-fns` (needed in later plans for timestamp formatting).
  </action>
  <verify>Run `npx prisma db push` — should succeed with no errors. Run `npx prisma validate` — schema is valid. Check `npm ls date-fns` shows installed.</verify>
  <done>Order model exists in database with all fields, enums, relations, and indexes. date-fns is installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create order state machine and validation schema</name>
  <files>src/lib/order-state-machine.ts, src/lib/validations/order.ts</files>
  <action>
Create `src/lib/order-state-machine.ts`:
- Import OrderStatus from '@prisma/client'
- Export ORDER_STATE_TRANSITIONS map: Record<OrderStatus, OrderStatus[]>
  - PENDING -> [ACCEPTED, CANCELLED]
  - ACCEPTED -> [IN_PROGRESS, CANCELLED]
  - IN_PROGRESS -> [COMPLETED, CANCELLED]
  - COMPLETED -> [] (terminal)
  - CANCELLED -> [] (terminal)
- Export canTransition(currentStatus, newStatus): boolean — checks if transition is in allowed list
- Export validateTransition(currentStatus, newStatus): { valid: boolean; error?: string } — returns error message if invalid
- Export getNextStates(currentStatus): OrderStatus[] — returns allowed next states for UI rendering

Create `src/lib/validations/order.ts`:
- Import z from 'zod'
- Export orderSchema = z.object({
    selectedTier: z.enum(['basic', 'standard', 'premium'], { errorMap: () => ({ message: 'Please select a pricing tier' }) }),
    deliveryNotes: z.string().max(1000, 'Delivery notes must be under 1000 characters').optional().nullable()
  })
- Export type OrderFormData = z.infer<typeof orderSchema>
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify both files export expected functions/types.</verify>
  <done>State machine validates transitions correctly (PENDING->ACCEPTED allowed, COMPLETED->anything blocked). Validation schema accepts valid tier selections and rejects invalid ones.</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` succeeds
2. `npx prisma db push` succeeds (or already applied)
3. `npx tsc --noEmit` passes with no errors
4. Order model has all required fields and relations
5. State machine correctly maps all 5 states with valid transitions
6. Validation schema accepts 'basic', 'standard', 'premium' and rejects other values
</verification>

<success_criteria>
- Order table exists in PostgreSQL with correct columns and indexes
- User model has buyerOrders and providerOrders relations
- Gig model has orders relation
- canTransition() returns true for valid transitions and false for invalid ones
- orderSchema validates tier selection and delivery notes correctly
- date-fns is installed for use in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/04-order-flow/04-01-SUMMARY.md`
</output>
