---
phase: 10-mock-data-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma.config.ts
  - prisma/seed.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Developer can run `npx prisma db seed` and see seed script execute successfully"
    - "Running seed command multiple times produces same results without errors"
    - "Seed script clears existing test data in correct dependency order before inserting"
    - "All TypeScript code compiles and runs without errors via tsx"
  artifacts:
    - path: "prisma/seed.ts"
      provides: "Seed script with cleanup, deterministic seeding, and idempotent upsert scaffold"
      min_lines: 80
    - path: "prisma.config.ts"
      provides: "Seed command configuration"
      contains: "seed:"
    - path: "package.json"
      provides: "@faker-js/faker dev dependency"
      contains: "@faker-js/faker"
  key_links:
    - from: "prisma.config.ts"
      to: "prisma/seed.ts"
      via: "seed: 'tsx prisma/seed.ts'"
      pattern: "seed.*tsx.*prisma/seed"
    - from: "prisma/seed.ts"
      to: "@prisma/client"
      via: "PrismaClient import with pg adapter"
      pattern: "PrismaClient|PrismaPg"
    - from: "prisma/seed.ts"
      to: "@faker-js/faker"
      via: "faker import with deterministic seed"
      pattern: "faker\\.seed"
---

<objective>
Set up mock data seed infrastructure: install Faker.js, configure Prisma seed command, and create the seed script with deterministic seeding, proper cleanup order, and idempotent upsert patterns.

Purpose: Establishes the foundation for Phase 11's mock data generation. Without this infrastructure, there's no way to populate the marketplace with realistic test data.
Output: Working `npx prisma db seed` command that executes a TypeScript seed script with cleanup and scaffold functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-mock-data-infrastructure/10-RESEARCH.md
@prisma/schema.prisma
@prisma.config.ts
@src/lib/db.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Faker.js and configure Prisma seed command</name>
  <files>package.json, prisma.config.ts</files>
  <action>
    1. Install @faker-js/faker as a dev dependency:
       ```bash
       npm install -D @faker-js/faker
       ```

    2. Update `prisma.config.ts` to add the seed command in the migrations config. Add this line inside the `migrations` object:
       ```typescript
       seed: "tsx prisma/seed.ts",
       ```
       The full migrations block should become:
       ```typescript
       migrations: {
         path: "prisma/migrations",
         seed: "tsx prisma/seed.ts",
       },
       ```
       Do NOT change any other part of prisma.config.ts.
  </action>
  <verify>
    - Run `npm ls @faker-js/faker` to confirm installation
    - Run `grep -q "seed" prisma.config.ts` to confirm seed config exists
  </verify>
  <done>@faker-js/faker appears in devDependencies; prisma.config.ts has seed command pointing to prisma/seed.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create seed script with cleanup, deterministic seeding, and idempotent upsert scaffold</name>
  <files>prisma/seed.ts</files>
  <action>
    Create `prisma/seed.ts` with the following structure. This script must work as standalone infrastructure that Phase 11 will extend with actual data.

    **IMPORTANT:** The seed script must initialize PrismaClient the same way as `src/lib/db.ts` ‚Äî using the `@prisma/adapter-pg` adapter with a `pg` Pool. Do NOT use bare `new PrismaClient()` without the adapter, as the project's Prisma v7 setup requires it. Load DATABASE_URL from `.env` file (Prisma CLI uses `.env`, not `.env.local`).

    **Structure:**

    ```typescript
    import { PrismaClient } from '@prisma/client';
    import { PrismaPg } from '@prisma/adapter-pg';
    import { Pool } from 'pg';
    import { faker } from '@faker-js/faker';
    import 'dotenv/config';

    // Initialize PrismaClient with pg adapter (same pattern as src/lib/db.ts)
    const pool = new Pool({ connectionString: process.env.DATABASE_URL });
    const adapter = new PrismaPg(pool);
    const prisma = new PrismaClient({ adapter });

    // Deterministic seed for reproducibility (SEED-06)
    const SEED_VALUE = 42;
    faker.seed(SEED_VALUE);

    // Cleanup in reverse dependency order (SEED-05)
    // Reviews ‚Üí Orders ‚Üí Conversations/Messages ‚Üí Gigs ‚Üí PortfolioImages ‚Üí Users
    async function cleanup() {
      console.log('üßπ Cleaning up existing seed data...');

      // Delete in reverse dependency order to respect foreign keys
      await prisma.review.deleteMany({});
      await prisma.message.deleteMany({});
      await prisma.conversation.deleteMany({});
      await prisma.order.deleteMany({});
      await prisma.gig.deleteMany({});
      await prisma.portfolioImage.deleteMany({});
      // Only delete seed users (identified by @example.com email)
      await prisma.user.deleteMany({
        where: { email: { endsWith: '@herafi-seed.test' } },
      });

      console.log('‚úÖ Cleanup complete');
    }

    // Seed users ‚Äî placeholder for Phase 11 (SEED-04: upsert pattern)
    async function seedUsers() {
      console.log('üë§ Seeding users...');

      // Phase 11 will populate this with 10-15 providers
      // Using upsert pattern for idempotency:
      // await prisma.user.upsert({
      //   where: { email: 'provider1@herafi-seed.test' },
      //   update: {},
      //   create: { ... },
      // });

      console.log('‚úÖ Users seeded');
    }

    // Seed gigs ‚Äî placeholder for Phase 11
    async function seedGigs() {
      console.log('üõ†Ô∏è Seeding gigs...');
      // Phase 11 will create 1-3 gigs per provider
      console.log('‚úÖ Gigs seeded');
    }

    // Seed orders ‚Äî placeholder for Phase 11
    async function seedOrders() {
      console.log('üì¶ Seeding orders...');
      // Phase 11 will create completed orders as review foundation
      console.log('‚úÖ Orders seeded');
    }

    // Seed reviews ‚Äî placeholder for Phase 11
    async function seedReviews() {
      console.log('‚≠ê Seeding reviews...');
      // Phase 11 will create 3-8 reviews per provider
      console.log('‚úÖ Reviews seeded');
    }

    // Update aggregate ratings ‚Äî placeholder for Phase 11
    async function updateAggregates() {
      console.log('üìä Updating aggregate ratings...');
      // Phase 11 will recalculate averageRating and totalReviews
      console.log('‚úÖ Aggregates updated');
    }

    // Main function with proper disconnect (Pattern 5 from research)
    async function main() {
      console.log('üå± Starting Herafi database seed...');
      console.log(`üìå Using deterministic seed: ${SEED_VALUE}`);

      await cleanup();
      await seedUsers();
      await seedGigs();
      await seedOrders();
      await seedReviews();
      await updateAggregates();

      console.log('üéâ Seeding completed successfully!');
    }

    main()
      .then(async () => {
        await prisma.$disconnect();
        await pool.end();
      })
      .catch(async (e) => {
        console.error('‚ùå Error during seeding:', e);
        await prisma.$disconnect();
        await pool.end();
        process.exit(1);
      });
    ```

    **Key decisions:**
    - Use `@herafi-seed.test` email domain (not `@example.com`) to clearly distinguish seed data from any real test accounts
    - Include `pool.end()` after `prisma.$disconnect()` to properly close the pg Pool connection (prevents process hanging)
    - Delete Messages and Conversations in cleanup even though Phase 11 won't seed them ‚Äî ensures clean state
    - Each seed function is a separate async function for clear organization and Phase 11 extensibility
    - Comments document the upsert pattern that Phase 11 will implement
  </action>
  <verify>
    - Run `npx prisma db seed` ‚Äî should execute without errors, printing all console.log messages
    - Run `npx prisma db seed` a second time ‚Äî should succeed again (idempotent cleanup)
    - Process should exit cleanly (no hanging)
  </verify>
  <done>
    - prisma/seed.ts exists with cleanup(), seedUsers(), seedGigs(), seedOrders(), seedReviews(), updateAggregates() functions
    - faker.seed(42) called at top level for determinism
    - Cleanup deletes in correct order: reviews ‚Üí messages ‚Üí conversations ‚Üí orders ‚Üí gigs ‚Üí portfolioImages ‚Üí users
    - Users cleanup only targets @herafi-seed.test emails
    - `npx prisma db seed` runs successfully twice in a row
  </done>
</task>

</tasks>

<verification>
1. `npm ls @faker-js/faker` shows installed version
2. `grep "seed" prisma.config.ts` shows seed configuration
3. `npx prisma db seed` executes successfully and prints all step messages
4. `npx prisma db seed` runs a second time without errors (idempotent)
5. Process exits cleanly after seed (no hanging terminal)
</verification>

<success_criteria>
- @faker-js/faker installed as dev dependency
- prisma.config.ts configured with `seed: "tsx prisma/seed.ts"`
- prisma/seed.ts has deterministic seeding (faker.seed), proper cleanup order, and scaffold functions
- `npx prisma db seed` works successfully on repeated runs
- All SEED-01 through SEED-06 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/10-mock-data-infrastructure/10-01-SUMMARY.md`
</output>
