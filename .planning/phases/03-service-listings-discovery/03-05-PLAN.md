---
phase: 03-service-listings-discovery
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/forms/GigForm.tsx
  - src/components/forms/ImageUploadSection.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Provider can create a gig with optional Standard/Premium tiers"
    - "Provider can upload up to 6 images for gig gallery with previews"
    - "Provider can remove uploaded images from gig"
  artifacts:
    - path: "src/components/forms/GigForm.tsx"
      provides: "Null-to-undefined transformation for pricing tiers, image upload UI in edit mode"
      min_lines: 280
    - path: "src/components/forms/ImageUploadSection.tsx"
      provides: "Image gallery management component"
      min_lines: 80
  key_links:
    - from: "src/components/forms/GigForm.tsx"
      to: "JSON.stringify"
      via: "null filtering before serialization"
      pattern: "standard: standardTier ?? undefined"
    - from: "src/components/forms/GigForm.tsx"
      to: "src/components/forms/ImageUploadSection.tsx"
      via: "conditional render in edit mode"
      pattern: "mode === \"edit\" && initialData?.slug"
    - from: "src/components/forms/ImageUploadSection.tsx"
      to: "src/actions/upload-gig-images.ts"
      via: "uploadGigImages and removeGigImage actions"
      pattern: "uploadGigImages\\(.*\\)|removeGigImage\\(.*\\)"
---

<objective>
Fix gig creation validation error and add image upload functionality.

Purpose: Close UAT gaps preventing gig creation and enabling image management.
Output: Working gig creation flow with optional pricing tiers, image upload in edit mode.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-listings-discovery/03-UAT.md
@src/components/forms/GigForm.tsx
@src/components/forms/PricingTierInput.tsx
@src/lib/validations/pricing.ts
@src/actions/upload-gig-images.ts
</context>

<tasks>

<task type="auto">
  <name>Fix pricing tier null validation error</name>
  <files>src/components/forms/GigForm.tsx</files>
  <action>
Fix the Zod validation error when Standard/Premium tiers are disabled.

**Root cause:** PricingTierInput emits `null` when disabled (line 50 in PricingTierInput.tsx). GigForm serializes this null directly into JSON (lines 193-197). Zod's `.optional()` accepts `undefined` but rejects `null`.

**Fix:** Transform null to undefined before JSON serialization.

In GigForm.tsx, update the hidden input value (currently lines 190-198):

```tsx
<input
  type="hidden"
  name="pricingTiers"
  value={JSON.stringify({
    basic: basicTier,
    standard: standardTier ?? undefined,
    premium: premiumTier ?? undefined,
  })}
/>
```

Change the serialization to replace null with undefined using the nullish coalescing operator (`??`). This ensures Zod receives `undefined` for disabled tiers (which `.optional()` accepts), not `null` (which it rejects).

**Why this works:** Zod's `.optional()` is equivalent to `.or(z.undefined())`, not `.nullable()`. The schema in pricing.ts (lines 35-36) expects `undefined` for optional tiers.

**Do NOT change:** PricingTierInput.tsx behavior (onChange(null) is correct), validation schema (`.optional()` is correct). Only fix the serialization layer.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/gigs/new as a provider
3. Fill out form with only Basic tier enabled (leave Standard/Premium disabled)
4. Submit form
5. Verify: No validation error, gig is created successfully
6. Check: Console shows no errors, redirect to /gigs/[slug] occurs
  </verify>
  <done>
Creating a gig with only Basic tier (Standard/Premium disabled) succeeds without validation errors. User is redirected to the created gig's detail page.
  </done>
</task>

<task type="auto">
  <name>Create image upload component</name>
  <files>src/components/forms/ImageUploadSection.tsx</files>
  <action>
Create a reusable image management component for the gig edit form.

**Requirements:**
- Display existing images (up to 6) in a grid with previews
- File input for uploading new images (multiple, accept image/*)
- Remove button on each image (X icon, top-right corner)
- Max 6 images total validation
- 5MB per image validation
- Show upload progress/pending state
- Use uploadGigImages and removeGigImage from @/actions/upload-gig-images

**Component signature:**
```tsx
type ImageUploadSectionProps = {
  gigSlug: string;
  initialImages: string[];
};
```

**UI structure:**
- Section heading: "Images (up to 6)"
- Grid of current images (grid-cols-2 sm:grid-cols-3 gap-4)
- Each image: relative container with preview img and remove button (absolute top-1 right-1)
- File input below grid (only show if < 6 images)
- Error message display area

**State management:**
- Local state for current images (initialize from initialImages)
- Local state for upload pending and error message
- Use FormData to send files to uploadGigImages action
- On successful upload: add new image URLs to state, revalidate
- On remove: call removeGigImage, remove from state on success

**Styling:**
- Images: aspect-square, object-cover, rounded-lg border
- Remove button: bg-red-600 text-white rounded-full p-1 hover:bg-red-700
- File input: styled like other form inputs (border-gray-300, rounded-md)
- Upload button: orange-600 bg, disabled state when uploading

**Error handling:**
- Show action.error in red alert box below upload button
- Clear error on new upload attempt
- Validate file count client-side before sending
  </action>
  <verify>
1. Check file exists: `ls src/components/forms/ImageUploadSection.tsx`
2. Verify exports: `grep "export default" src/components/forms/ImageUploadSection.tsx`
3. Check imports: `grep -E "(uploadGigImages|removeGigImage)" src/components/forms/ImageUploadSection.tsx`
4. Verify file count validation: `grep "MAX.*6\|length.*6" src/components/forms/ImageUploadSection.tsx`
  </verify>
  <done>
ImageUploadSection.tsx exists with proper component structure, imports both upload actions, validates 6-image limit, and renders image grid with remove functionality.
  </done>
</task>

<task type="auto">
  <name>Integrate image upload into GigForm</name>
  <files>src/components/forms/GigForm.tsx</files>
  <action>
Add image upload section to GigForm in edit mode only.

**Why edit mode only:** Images require a gig slug (uploadGigImages needs gigSlug parameter). On create, gig doesn't exist yet. Two-step flow: create gig first, then redirect to edit page for images.

**Integration steps:**

1. Import ImageUploadSection at top of GigForm.tsx:
```tsx
import ImageUploadSection from "./ImageUploadSection";
```

2. Add new section AFTER the Pricing Tiers section (after line 205), BEFORE the Submit Button section (before line 207):

```tsx
{/* Image Gallery Section - Edit Mode Only */}
{mode === "edit" && initialData?.slug && (
  <section className="bg-white rounded-lg border border-gray-200 p-6">
    <h2 className="text-xl font-semibold text-gray-900 mb-2">
      Image Gallery
    </h2>
    <p className="text-sm text-gray-600 mb-6">
      Upload up to 6 images to showcase your service. Images help buyers understand what you offer.
    </p>
    <ImageUploadSection
      gigSlug={initialData.slug}
      initialImages={initialData.images ?? []}
    />
  </section>
)}
```

3. Update redirect behavior (line 62-65). Currently redirects to gig detail on success. For create mode, redirect to edit page instead so user can immediately add images:

```tsx
useEffect(() => {
  if (state.success && state.slug) {
    if (mode === "create") {
      router.push(`/gigs/${state.slug}/edit`);
    } else {
      router.push(`/gigs/${state.slug}`);
    }
  }
}, [state.success, state.slug, mode, router]);
```

**Result:** Create flow becomes: fill form → create gig → redirect to edit page with success message → add images → save/view gig.

**Do NOT:** Add image upload to create mode (gig doesn't exist yet), modify ImageUploadSection component (already complete), change form submission logic.
  </action>
  <verify>
1. Check import: `grep "import ImageUploadSection" src/components/forms/GigForm.tsx`
2. Check conditional render: `grep -A 3 "mode === \"edit\" && initialData?.slug" src/components/forms/GigForm.tsx`
3. Check redirect logic: `grep -A 6 "if (mode === \"create\")" src/components/forms/GigForm.tsx`
4. Start dev server and test full flow:
   - Create a new gig at /gigs/new (only Basic tier)
   - Verify: redirects to /gigs/[slug]/edit after creation
   - Verify: Image Gallery section appears on edit page
   - Upload 2-3 images
   - Verify: images appear in grid with remove buttons
   - Click remove on one image
   - Verify: image is removed from grid
   - Navigate to /gigs/[slug]
   - Verify: images appear in detail page gallery
  </verify>
  <done>
GigForm imports ImageUploadSection, conditionally renders it in edit mode, and redirects to edit page after creation. Full create-then-upload flow works: create gig → redirects to edit → add images → images persist and display on detail page.
  </done>
</task>

</tasks>

<verification>
Run complete gig creation and image upload flow:

1. Navigate to /gigs/new as provider
2. Create gig with only Basic tier enabled
3. Verify: No validation error, redirects to /gigs/[slug]/edit
4. Upload 3 images on edit page
5. Verify: All 3 images appear in preview grid
6. Remove 1 image
7. Verify: Grid shows 2 images
8. Navigate to /gigs/[slug]
9. Verify: Detail page shows 2 images in gallery
10. Try uploading 6 total images (should succeed)
11. Try uploading a 7th image (should show error: "Maximum 6 images")

All UAT tests 1-4 should now pass:
- Test 1: Create gig with optional tiers
- Test 2: Image upload with previews and removal
- Test 3: Edit existing gig (now testable)
- Test 4: Delete gig (now testable)
</verification>

<success_criteria>
- Gig creation with disabled Standard/Premium tiers succeeds (no validation error)
- Creating a gig redirects to edit page for image upload
- ImageUploadSection component exists and integrates with upload actions
- Edit page displays image upload section with grid and file input
- Uploading images adds them to grid with remove buttons
- Removing images deletes them from grid and filesystem
- Image count validation prevents uploading more than 6 images
- Uploaded images persist and display on gig detail page
- UAT gaps 1 and 2 are closed
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-listings-discovery/03-05-SUMMARY.md`
</output>
