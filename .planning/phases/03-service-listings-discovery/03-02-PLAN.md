---
phase: 03-service-listings-discovery
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/actions/gigs.ts
  - src/actions/upload-gig-images.ts
  - src/app/gigs/new/page.tsx
  - src/app/gigs/[slug]/edit/page.tsx
  - src/components/forms/GigForm.tsx
  - src/components/forms/PricingTierInput.tsx
autonomous: true

must_haves:
  truths:
    - "Provider can create a gig with title, description, category, and pricing tiers"
    - "Provider can edit their own gigs"
    - "Provider can delete their own gigs"
    - "Gig images can be uploaded and attached to a gig"
    - "Non-providers cannot create gigs"
    - "Users cannot edit or delete gigs they don't own"
  artifacts:
    - path: "src/actions/gigs.ts"
      provides: "Gig CRUD server actions"
      exports: ["createGig", "updateGig", "deleteGig", "GigActionState"]
    - path: "src/actions/upload-gig-images.ts"
      provides: "Gig image upload server action"
      exports: ["uploadGigImages", "removeGigImage"]
    - path: "src/app/gigs/new/page.tsx"
      provides: "Create gig page (provider only)"
    - path: "src/app/gigs/[slug]/edit/page.tsx"
      provides: "Edit gig page (owner only)"
    - path: "src/components/forms/GigForm.tsx"
      provides: "Reusable gig creation/edit form"
    - path: "src/components/forms/PricingTierInput.tsx"
      provides: "Pricing tier form section"
  key_links:
    - from: "src/actions/gigs.ts"
      to: "src/lib/validations/gig.ts"
      via: "Validates form data with gigSchema"
      pattern: "gigSchema\\.safeParse"
    - from: "src/actions/gigs.ts"
      to: "src/lib/slug.ts"
      via: "Generates slug on create"
      pattern: "generateUniqueGigSlug"
    - from: "src/components/forms/GigForm.tsx"
      to: "src/actions/gigs.ts"
      via: "useActionState for form submission"
      pattern: "useActionState.*createGig|updateGig"
    - from: "src/app/gigs/new/page.tsx"
      to: "src/components/forms/GigForm.tsx"
      via: "Renders GigForm in create mode"
      pattern: "<GigForm"
---

<objective>
Implement gig CRUD operations — server actions for create, edit, delete, and image upload, plus the form UI for creating and editing gigs.

Purpose: This enables providers to create and manage their service listings, which is the core content creation flow of the marketplace.
Output: Server actions for gig CRUD, image upload action, create/edit pages, reusable gig form with pricing tier inputs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-listings-discovery/03-01-SUMMARY.md
@src/actions/profile.ts
@src/actions/upload-portfolio.ts
@src/lib/auth.ts
@src/lib/db.ts
@src/lib/validations/gig.ts
@src/lib/validations/pricing.ts
@src/lib/slug.ts
@src/lib/file-upload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gig CRUD server actions and image upload action</name>
  <files>
    src/actions/gigs.ts
    src/actions/upload-gig-images.ts
  </files>
  <action>
**src/actions/gigs.ts:**
Follow the pattern from `src/actions/profile.ts` (server actions with auth check, Zod validation, prisma operations).

Export `GigActionState` type: `{ success: boolean; slug?: string; error?: string; fieldErrors?: Record<string, string[]> }`.

1. `createGig(_prevState: GigActionState, formData: FormData): Promise<GigActionState>`:
   - Check auth via `auth()`. Return error if not authenticated.
   - Verify user `isProvider` via prisma lookup. Return error if not provider.
   - Extract title, description, category from formData.
   - Extract pricingTiers from formData — it's a JSON string, parse with `JSON.parse(formData.get('pricingTiers'))`.
   - Validate with `gigSchema.safeParse`. Return fieldErrors on failure.
   - Generate slug via `generateUniqueGigSlug(title)`.
   - `prisma.gig.create` with all fields + `providerId: session.user.id`.
   - Revalidate `/gigs` and `/dashboard`.
   - Return `{ success: true, slug }`.

2. `updateGig(gigSlug: string, _prevState: GigActionState, formData: FormData): Promise<GigActionState>`:
   - Check auth. Verify user owns the gig (`prisma.gig.findUnique` where slug + check providerId).
   - Parse and validate form data same as create.
   - If title changed, generate new slug via `generateUniqueGigSlug(title, gig.id)`.
   - `prisma.gig.update` with new data.
   - Revalidate old and new slug paths.
   - Return `{ success: true, slug: newSlug }`.

3. `deleteGig(gigSlug: string): Promise<{ success: boolean; error?: string }>`:
   - Check auth. Verify ownership.
   - Delete gig images from filesystem (iterate gig.images, call `deleteFile` for each).
   - `prisma.gig.delete({ where: { slug: gigSlug } })`.
   - Revalidate `/gigs` and `/dashboard`.
   - Return `{ success: true }`.

**src/actions/upload-gig-images.ts:**
Follow the pattern from `src/actions/upload-portfolio.ts`.

`MAX_GIG_IMAGES = 6`

1. `uploadGigImages(gigSlug: string, formData: FormData)`:
   - Check auth. Verify ownership.
   - Check current image count + new files <= MAX_GIG_IMAGES.
   - Validate each file: max 5MB, use `saveFile(file, 'gigs')`.
   - Update gig with `images: { push: newImageUrls }`.
   - Revalidate gig path.
   - Return `{ success: true, imageUrls }`.

2. `removeGigImage(gigSlug: string, imageUrl: string)`:
   - Check auth. Verify ownership.
   - Remove imageUrl from gig.images array (filter out and update).
   - Delete file from filesystem via `deleteFile(imageUrl)`.
   - Revalidate gig path.
   - Return `{ success: true }`.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify all action functions are exported as async server actions with 'use server' directive.</verify>
  <done>Server actions exist for creating, updating, and deleting gigs, plus uploading and removing gig images. All actions validate auth, ownership, and input data.</done>
</task>

<task type="auto">
  <name>Task 2: Create gig form components and create/edit pages</name>
  <files>
    src/components/forms/PricingTierInput.tsx
    src/components/forms/GigForm.tsx
    src/app/gigs/new/page.tsx
    src/app/gigs/[slug]/edit/page.tsx
  </files>
  <action>
**src/components/forms/PricingTierInput.tsx:**
Client component (`'use client'`) for editing a single pricing tier.

Props: `{ tierName: 'Basic' | 'Standard' | 'Premium'; required?: boolean; defaultValue?: PricingTier; onChange: (tier: PricingTier | null) => void }`.

- For optional tiers (Standard/Premium), include an "Enable" toggle. When disabled, call onChange(null).
- Fields: price (number input), description (textarea, 10-200 chars), deliveryDays (number), revisions (number), features (comma-separated string input, split into array).
- Style with Tailwind: card-like container with tier name as header, warm border color (orange for Premium, amber for Standard, gray for Basic).
- Call onChange with the full tier object whenever any field changes.

**src/components/forms/GigForm.tsx:**
Client component for creating and editing gigs.

Props: `{ mode: 'create' | 'edit'; initialData?: GigFormData & { slug?: string; images?: string[] }; action: (prevState: GigActionState, formData: FormData) => Promise<GigActionState> }`.

- Use `useActionState` from React for form submission (follow pattern from existing profile forms).
- Form fields:
  1. Title: text input (10-100 chars)
  2. Description: textarea (50-5000 chars) with character count
  3. Category: select dropdown with all 13 categories (display human-readable labels like "Plumbing", "Car Washing", "Digital Design")
  4. Pricing Tiers: render 3 `PricingTierInput` components (Basic required, Standard/Premium optional)
- Manage pricing tiers state locally, serialize to JSON in a hidden input named `pricingTiers` before submission.
- Display field errors from action state.
- On success: redirect to `/gigs/${state.slug}` using `useRouter`.
- Style with Tailwind: single scrolling form (consistent with Phase 2 decision), warm color scheme, clear section headings.

**Category labels mapping:** Create a `CATEGORY_LABELS` record mapping enum values to display names:
PLUMBING -> "Plumbing", PAINTING -> "Painting", CLEANING -> "Cleaning", CARPENTRY -> "Carpentry", WELDING -> "Welding", ELECTRICAL -> "Electrical", HVAC -> "HVAC", LANDSCAPING -> "Landscaping", MOVING -> "Moving", CAR_WASHING -> "Car Washing", DIGITAL_DESIGN -> "Digital Design", DIGITAL_WRITING -> "Digital Writing", OTHER -> "Other".

Export this mapping from the form component or a shared constants file so it can be reused in browse pages.

**src/app/gigs/new/page.tsx:**
Server component. Protected page — only providers can access.
- Check auth. If not authenticated, redirect to `/auth/login`.
- Check `isProvider`. If not provider, redirect to `/provider/setup`.
- Render `<GigForm mode="create" action={createGig} />`.
- Page title: "Create a New Gig".

**src/app/gigs/[slug]/edit/page.tsx:**
Server component. Only gig owner can access.
- Check auth. Redirect if not authenticated.
- Load gig by slug from params (await params — Next.js 15 pattern).
- Verify ownership (gig.providerId === session.user.id). If not owner, redirect to gig detail page.
- If gig not found, call `notFound()`.
- Render `<GigForm mode="edit" initialData={gig} action={updateGig.bind(null, gig.slug)} />`.
- Page title: "Edit Gig".
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Navigate to `/gigs/new` — form renders with all fields. Navigate to `/gigs/[slug]/edit` for an existing gig — form pre-fills with gig data. Non-providers are redirected from /gigs/new.
  </verify>
  <done>GigForm component renders create/edit forms with title, description, category dropdown, and 3 pricing tier inputs. Create page is provider-only. Edit page is owner-only. Form submits via server action and redirects on success.</done>
</task>

</tasks>

<verification>
1. Provider can create a gig at /gigs/new — form validates, gig appears in database
2. Provider can edit their gig at /gigs/[slug]/edit — changes persist
3. Provider can delete their gig — removed from database and filesystem images cleaned up
4. Non-provider redirected from /gigs/new to /provider/setup
5. Non-owner redirected from /gigs/[slug]/edit
6. Gig images can be uploaded (max 6) and removed
7. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Server actions handle gig CRUD with auth, ownership, and validation checks
- GigForm component works for both create and edit modes
- Pricing tier inputs allow Basic (required) + optional Standard/Premium
- Category dropdown shows all 13 categories with human-readable labels
- Create/edit pages enforce provider/ownership access control
- Image upload/remove works for gig galleries
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-listings-discovery/03-02-SUMMARY.md`
</output>
