---
phase: 03-service-listings-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/gig.ts
  - src/lib/validations/pricing.ts
  - src/lib/slug.ts
  - src/lib/search.ts
  - src/lib/file-upload.ts
autonomous: true

must_haves:
  truths:
    - "Gig model exists in database with title, description, category enum, JSONB pricing tiers, images array, slug, isActive flag"
    - "Category enum defines 13 service categories"
    - "Zod schemas validate gig form data including pricing tier structure"
    - "Slug generation produces unique URL-safe slugs from gig titles"
    - "Search query builder constructs Prisma where clauses from filter params"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Gig model, Category enum, User.gigs relation"
      contains: "model Gig"
    - path: "src/lib/validations/gig.ts"
      provides: "Gig form validation schema"
      exports: ["gigSchema", "GigFormData"]
    - path: "src/lib/validations/pricing.ts"
      provides: "Pricing tier validation"
      exports: ["pricingTierSchema", "pricingTiersSchema", "PricingTier", "PricingTiers"]
    - path: "src/lib/slug.ts"
      provides: "Unique slug generation"
      exports: ["generateUniqueGigSlug"]
    - path: "src/lib/search.ts"
      provides: "Search query construction"
      exports: ["buildGigSearchWhere", "searchGigs", "GigSearchFilters"]
    - path: "src/lib/file-upload.ts"
      provides: "Extended saveFile with gigs subDir"
  key_links:
    - from: "src/lib/validations/gig.ts"
      to: "src/lib/validations/pricing.ts"
      via: "imports pricingTiersSchema"
      pattern: "import.*pricingTiersSchema.*from.*pricing"
    - from: "src/lib/search.ts"
      to: "prisma/schema.prisma"
      via: "Prisma types for Category and GigWhereInput"
      pattern: "import.*Category.*Prisma.*from.*@prisma/client"
    - from: "src/lib/slug.ts"
      to: "src/lib/db.ts"
      via: "prisma client for uniqueness check"
      pattern: "prisma\\.gig\\.findUnique"
---

<objective>
Set up the database schema, validation schemas, and utility functions for the gig marketplace.

Purpose: This plan creates the foundational data layer that all other Phase 3 plans depend on — the Gig model, category taxonomy, pricing validation, slug generation, and search query building.
Output: Database schema with Gig model, Zod validation schemas, slug utility, search query builder, extended file upload helper.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/lib/db.ts
@src/lib/file-upload.ts
@src/lib/validations/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema with Gig model and Category enum</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma:

1. Add `previewFeatures = ["fullTextSearch"]` to the generator client block to enable PostgreSQL full-text search.

2. Add a `Category` enum with these 13 values: PLUMBING, PAINTING, CLEANING, CARPENTRY, WELDING, ELECTRICAL, HVAC, LANDSCAPING, MOVING, CAR_WASHING, DIGITAL_DESIGN, DIGITAL_WRITING, OTHER.

3. Add a `Gig` model with these fields:
   - `id String @id @default(cuid())`
   - `slug String @unique`
   - `title String`
   - `description String @db.Text`
   - `category Category`
   - `images String[] @default([])`
   - `pricingTiers Json` (JSONB — structure: { basic: {...}, standard?: {...}, premium?: {...} })
   - `providerId String`
   - `provider User @relation(fields: [providerId], references: [id], onDelete: Cascade)`
   - `isActive Boolean @default(true)`
   - `createdAt DateTime @default(now())`
   - `updatedAt DateTime @updatedAt`
   - Indexes: `@@index([category])`, `@@index([providerId])`, `@@index([isActive])`

4. Add `gigs Gig[]` relation to the User model (alongside existing portfolioImages).

5. Run `npx prisma db push` to apply schema changes. If it fails due to fullTextSearch preview, check Prisma v7 docs — the preview feature may already be GA in v7 (if so, remove the previewFeatures line and retry).
  </action>
  <verify>Run `npx prisma db push` — exits 0 with no errors. Run `npx prisma generate` — exits 0. Verify Category and Gig types exist in generated client.</verify>
  <done>Gig model and Category enum exist in database. User model has gigs relation. Prisma client generated with full-text search support.</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas, slug utility, search builder, and extend file upload</name>
  <files>
    src/lib/validations/pricing.ts
    src/lib/validations/gig.ts
    src/lib/slug.ts
    src/lib/search.ts
    src/lib/file-upload.ts
  </files>
  <action>
**src/lib/validations/pricing.ts:**
Create Zod schemas for pricing tiers:
- `pricingTierSchema`: object with `name` (enum Basic/Standard/Premium), `price` (positive number, max 999999), `description` (string 10-200 chars), `deliveryDays` (positive int, max 365), `revisions` (nonneg int, max 99), `features` (array of strings, max 10 items, each 1-100 chars).
- `pricingTiersSchema`: object with `basic` (required pricingTierSchema), `standard` (optional), `premium` (optional).
- Export types: `PricingTier`, `PricingTiers`.

**src/lib/validations/gig.ts:**
Create Zod schema for gig form:
- Import `pricingTiersSchema` from `./pricing`.
- `gigSchema`: object with `title` (string 10-100 chars), `description` (string 50-5000 chars), `category` (z.enum with all 13 Category values as strings), `pricingTiers` (pricingTiersSchema).
- Export type `GigFormData`.

**src/lib/slug.ts:**
Install `slugify` package first: `npm install slugify`.
- Import slugify, crypto, and prisma from `@/lib/db`.
- Export `generateUniqueGigSlug(title: string, gigId?: string): Promise<string>`.
- Generate base slug with `slugify(title, { lower: true, strict: true, trim: true })`.
- Append 6-char random hex suffix: `crypto.randomBytes(3).toString('hex')`.
- Check uniqueness via `prisma.gig.findUnique({ where: { slug } })`.
- If collision and not same gigId, recursively retry.
- Return unique slug.

**src/lib/search.ts:**
- Import `Category`, `Prisma` from `@prisma/client`, and prisma from `@/lib/db`.
- Export `GigSearchFilters` interface: `query?`, `category?` (Category), `minPrice?`, `maxPrice?` (numbers).
- Export `buildGigSearchWhere(filters)`: Returns `Prisma.GigWhereInput`. Always includes `isActive: true`. Adds full-text search OR clause on title+description if query provided. Adds category filter if provided. Adds JSONB price range filter on `pricingTiers.basic.price` path if min/max price provided.
- Export `searchGigs(filters, page=1, pageSize=12)`: Calls buildGigSearchWhere, then `prisma.gig.findMany` with include provider (id, username, displayName, avatarUrl), orderBy `_relevance` if query or `createdAt desc` otherwise, skip/take pagination. Also runs `prisma.gig.count` in parallel. Returns `{ gigs, total, page, pageSize, totalPages }`.

**src/lib/file-upload.ts:**
Extend the `saveFile` function's `subDir` parameter type to include `"gigs"`:
- Change `subDir: "avatars" | "portfolio"` to `subDir: "avatars" | "portfolio" | "gigs"`.
- No other changes needed — the function already handles arbitrary subdirs.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in new files. Verify imports resolve correctly:
- `src/lib/validations/gig.ts` imports from `./pricing`
- `src/lib/slug.ts` imports from `@/lib/db`
- `src/lib/search.ts` imports from `@prisma/client` and `@/lib/db`
  </verify>
  <done>Zod schemas validate gig form data with pricing tiers. Slug generator produces unique URL-safe slugs. Search builder constructs Prisma where clauses from filter params. File upload supports gigs subdirectory.</done>
</task>

</tasks>

<verification>
1. `npx prisma db push` succeeds — Gig model and Category enum in database
2. `npx prisma generate` succeeds — types available in client
3. `npx tsc --noEmit` passes — all new files type-check
4. Schema has fullTextSearch support (preview feature or GA)
5. All 5 new/modified utility files exist with correct exports
</verification>

<success_criteria>
- Gig model in database with all fields, indexes, and User relation
- Category enum with 13 values
- Zod schemas for gig and pricing tier validation
- Slug utility generates unique slugs from titles
- Search builder constructs filtered Prisma queries
- File upload helper extended for gigs subdirectory
- All files type-check without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-listings-discovery/03-01-SUMMARY.md`
</output>
